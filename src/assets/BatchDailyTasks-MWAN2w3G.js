import{v as useTokenStore,q as useMessage,r as ref,p as computed,y as reactive,x as watch,o as onMounted,Z as onBeforeUnmount,R as nextTick,c as createElementBlock,a as createBaseVNode,b as createVNode,e as createBlock,z as createCommentVNode,t as toDisplayString,w as withCtx,d as resolveComponent,i as openBlock,j as createTextVNode,u as unref,F as Fragment,g as renderList,D as withModifiers,J as normalizeStyle,A as normalizeClass,a2 as preloadQuestions}from"./index-XtqsXPhp.js";import{D as DailyTaskRunner}from"./dailyTaskRunner-DWx6pS_M.js";import{_ as _export_sfc}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as Settings}from"./Settings-BO-Kgxki.js";const _hoisted_1={class:"batch-daily-tasks"},_hoisted_2={class:"main-layout"},_hoisted_3={class:"left-column"},_hoisted_4={class:"page-header",style:{display:"flex","justify-content":"space-between","align-items":"center","flex-wrap":"wrap",gap:"12px"}},_hoisted_5={style:{display:"flex","align-items":"center",gap:"16px"}},_hoisted_6={style:{display:"flex","align-items":"center",gap:"12px",padding:"8px 12px","background-color":"#f8f9fa","border-radius":"8px",border:"1px solid #e9ecef"}},_hoisted_7={style:{"font-size":"14px",color:"#495057"}},_hoisted_8={key:0,style:{"font-size":"14px","font-weight":"500",color:"#1677ff"}},_hoisted_9={key:1,style:{"font-size":"14px",color:"#6c757d"}},_hoisted_10={style:{display:"flex",gap:"8px"}},_hoisted_11={style:{display:"flex","align-items":"center",gap:"12px",padding:"8px 12px","background-color":"#f8f9fa","border-radius":"8px",border:"1px solid #e9ecef"}},_hoisted_12={class:"sort-buttons",style:{"margin-bottom":"12px"}},_hoisted_13={class:"token-row"},_hoisted_14={class:"token-item"},_hoisted_15={class:"task-preview",style:{margin:"16px 0",padding:"16px",border:"1px solid #e5e7eb","border-radius":"8px","background-color":"#fafafa"}},_hoisted_16={key:0,style:{display:"flex","flex-direction":"column","align-items":"center",padding:"12px","background-color":"white","border-radius":"6px","box-shadow":"0 2px 8px rgba(0, 0, 0, 0.1)"}},_hoisted_17={style:{"font-size":"16px","font-weight":"bold","margin-bottom":"8px"}},_hoisted_18={key:1,style:{"text-align":"center",padding:"24px",color:"#6b7280","font-style":"italic"}},_hoisted_19={key:0,class:"tasks-count"},_hoisted_20={key:1,class:"tasks-count"},_hoisted_21={class:"right-column"},_hoisted_22={class:"custom-card-header"},_hoisted_23={class:"card-title"},_hoisted_24={class:"log-header-controls"},_hoisted_25={class:"time"},_hoisted_26={class:"message"},_hoisted_27={class:"settings-content"},_hoisted_28={class:"settings-grid"},_hoisted_29={class:"setting-item"},_hoisted_30={class:"setting-item"},_hoisted_31={class:"setting-item"},_hoisted_32={class:"setting-switches"},_hoisted_33={class:"switch-row"},_hoisted_34={class:"switch-row"},_hoisted_35={class:"switch-row"},_hoisted_36={class:"switch-row"},_hoisted_37={class:"switch-row"},_hoisted_38={class:"switch-row"},_hoisted_39={class:"switch-row"},_hoisted_40={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_41={class:"settings-content"},_hoisted_42={class:"settings-grid"},_hoisted_43={class:"setting-item"},_hoisted_44={class:"setting-item"},_hoisted_45={class:"setting-item"},_hoisted_46={class:"setting-item"},_hoisted_47={class:"setting-switches"},_hoisted_48={class:"switch-row"},_hoisted_49={class:"switch-row"},_hoisted_50={class:"switch-row"},_hoisted_51={class:"switch-row"},_hoisted_52={class:"switch-row"},_hoisted_53={class:"switch-row"},_hoisted_54={class:"switch-row"},_hoisted_55={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_56={class:"settings-content"},_hoisted_57={class:"settings-grid"},_hoisted_58={class:"setting-item"},_hoisted_59={class:"setting-item"},_hoisted_60={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_61={class:"settings-content"},_hoisted_62={class:"modal-header-actions",style:{"margin-bottom":"16px",display:"flex","justify-content":"space-between","align-items":"center"}},_hoisted_63={class:"template-list",style:{"max-height":"400px","overflow-y":"auto","margin-bottom":"16px"}},_hoisted_64={style:{display:"flex","justify-content":"space-between","align-items":"center"}},_hoisted_65={style:{margin:"0","margin-bottom":"8px"}},_hoisted_66={style:{"font-size":"12px",color:"#86909c"}},_hoisted_67={key:0},_hoisted_68={style:{display:"flex",gap:"8px"}},_hoisted_69={key:0,style:{"text-align":"center",padding:"24px",color:"#86909c"}},_hoisted_70={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_71={class:"settings-content"},_hoisted_72={class:"modal-header-actions",style:{"margin-bottom":"16px",display:"flex","justify-content":"space-between","align-items":"center"}},_hoisted_73={style:{display:"flex",gap:"8px","align-items":"center"}},_hoisted_74={class:"account-template-list",style:{"max-height":"400px","overflow-y":"auto","margin-bottom":"16px"}},_hoisted_75={style:{display:"flex","justify-content":"space-between","align-items":"center"}},_hoisted_76={style:{margin:"0","margin-bottom":"4px"}},_hoisted_77={key:0,style:{"text-align":"center",padding:"24px",color:"#86909c"}},_hoisted_78={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_79={class:"settings-content"},_hoisted_80={class:"settings-grid"},_hoisted_81={class:"setting-item"},_hoisted_82={key:0,class:"setting-item"},_hoisted_83={class:"recipient-info",style:{background:"#f7f8fa",padding:"16px","border-radius":"8px",border:"1px solid #e5e7eb",display:"flex","align-items":"flex-start",gap:"16px",transition:"all 0.3s ease"}},_hoisted_84={class:"avatar-container",style:{position:"relative",width:"80px",height:"80px","border-radius":"50%",overflow:"hidden",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)","box-shadow":"0 4px 12px rgba(0, 0, 0, 0.15)",display:"flex","align-items":"center","justify-content":"center",transition:"all 0.3s ease"}},_hoisted_85=["src"],_hoisted_86={key:1,class:"avatar-fallback",style:{display:"flex","align-items":"center","justify-content":"center",width:"100%",height:"100%",color:"white","font-size":"24px","font-weight":"bold","text-shadow":"0 2px 4px rgba(0, 0, 0, 0.3)"}},_hoisted_87={key:2,class:"avatar-loading",style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(0, 0, 0, 0.5)",display:"flex","align-items":"center","justify-content":"center","border-radius":"50%"}},_hoisted_88={class:"role-info",style:{flex:"1","min-width":"0"}},_hoisted_89={style:{"margin-bottom":"12px","font-size":"18px","font-weight":"bold",color:"#1d2129","text-shadow":"0 1px 2px rgba(0, 0, 0, 0.1)"}},_hoisted_90={class:"role-info-grid",style:{display:"grid","grid-template-columns":"1fr 1fr",gap:"12px"}},_hoisted_91={class:"info-item"},_hoisted_92={class:"info-value",style:{"font-size":"14px","font-weight":"500",color:"#1d2129"}},_hoisted_93={class:"info-item"},_hoisted_94={class:"info-value",style:{"font-size":"14px","font-weight":"500",color:"#1d2129"}},_hoisted_95={class:"info-item"},_hoisted_96={class:"info-value",style:{"font-size":"16px","font-weight":"600",color:"#667eea"}},_hoisted_97={class:"info-item"},_hoisted_98={class:"info-value",style:{"font-size":"14px","font-weight":"500",color:"#1d2129"}},_hoisted_99={class:"info-item",style:{"grid-column":"1 / -1"}},_hoisted_100={class:"info-value",style:{"font-size":"14px","font-weight":"500",color:"#1d2129"}},_hoisted_101={class:"setting-item"},_hoisted_102={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_103={class:"settings-content"},_hoisted_104={class:"settings-grid"},_hoisted_105={key:0,class:"setting-item"},_hoisted_106={key:1,class:"setting-item"},_hoisted_107={class:"setting-item"},_hoisted_108={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_109={class:"tasks-list",style:{"max-height":"600px","overflow-y":"auto"}},_hoisted_110={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"8px"}},_hoisted_111={style:{"font-weight":"bold"}},_hoisted_112={style:{"margin-bottom":"4px"}},_hoisted_113={style:{"margin-bottom":"4px"}},_hoisted_114={style:{"margin-bottom":"4px"}},_hoisted_115={style:{"margin-bottom":"4px"}},_hoisted_116={style:{"margin-bottom":"8px"}},_hoisted_117={style:{display:"flex",gap:"8px"}},_hoisted_118={key:0,style:{"text-align":"center",padding:"24px",color:"#6b7280"}},_hoisted_119={class:"settings-content"},_hoisted_120={class:"settings-grid"},_hoisted_121={class:"setting-item"},_hoisted_122={class:"setting-item"},_hoisted_123={key:0,class:"setting-item"},_hoisted_124={key:1,class:"setting-item"},_hoisted_125={key:0,class:"cron-parser"},_hoisted_126={key:0,class:"cron-validation success"},_hoisted_127={key:1,class:"cron-validation error"},_hoisted_128={key:2,class:"cron-next-runs"},_hoisted_129={class:"setting-item"},_hoisted_130={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"8px"}},_hoisted_131={class:"setting-item"},_hoisted_132={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"8px"}},_hoisted_133={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_134={class:"settings-content"},_hoisted_135={class:"settings-grid"},_hoisted_136={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_137={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_138={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_139={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_140={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_141={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_142={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_143={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_144={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_145={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_146={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_147={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_148={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_149={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_150={class:"setting-item",style:{"flex-direction":"row","justify-content":"space-between","align-items":"center"}},_hoisted_151={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},FISH_TARGET=320,ARENA_TARGET=240,FOUR_HOURS_MS=4*60*60*1e3,_sfc_main={__name:"BatchDailyTasks",setup(__props){const tokenStore=useTokenStore(),message=useMessage(),savedSortConfig=localStorage.getItem("tokenSortConfig"),sortConfig=ref(savedSortConfig?JSON.parse(savedSortConfig):{field:"createdAt",direction:"asc"}),sortedTokens=computed(()=>[...tokenStore.gameTokens].sort((a,e)=>{var n,i,r,l,c,u;let t,s;switch(sortConfig.value.field){case"name":t=((n=a.name)==null?void 0:n.toLowerCase())||"",s=((i=e.name)==null?void 0:i.toLowerCase())||"";break;case"server":t=((r=a.server)==null?void 0:r.toLowerCase())||"",s=((l=e.server)==null?void 0:l.toLowerCase())||"";break;case"createdAt":t=new Date(a.createdAt||0).getTime(),s=new Date(e.createdAt||0).getTime();break;case"lastUsed":t=new Date(a.lastUsed||0).getTime(),s=new Date(e.lastUsed||0).getTime();break;default:t=((c=a.name)==null?void 0:c.toLowerCase())||"",s=((u=e.name)==null?void 0:u.toLowerCase())||""}return t<s?sortConfig.value.direction==="asc"?-1:1:t>s?sortConfig.value.direction==="asc"?1:-1:0})),toggleSort=a=>{sortConfig.value.field===a?sortConfig.value.direction=sortConfig.value.direction==="asc"?"desc":"asc":(sortConfig.value.field=a,sortConfig.value.direction="asc"),localStorage.setItem("tokenSortConfig",JSON.stringify(sortConfig.value))},getSortIcon=a=>sortConfig.value.field!==a?null:sortConfig.value.direction==="asc"?"↑":"↓",tokens=computed(()=>tokenStore.gameTokens),isCarActivityOpen=computed(()=>{const a=new Date().getDay();return a>=1&&a<=3}),ismengjingActivityOpen=computed(()=>{const a=new Date().getDay();return a===0||a===1||a===3||a===4}),isbaokuActivityOpen=computed(()=>{const a=new Date().getDay();return a!=1&&a!=2}),isarenaActivityOpen=computed(()=>{const a=new Date().getHours();return a>=6&&a<22}),getCurrentActivityWeek=computed(()=>{const a=new Date,e=new Date("2025-12-12T12:00:00"),t=7*24*60*60*1e3,s=3*t,n=a-e;if(n<0)return null;const i=n%s;return i<t?"黑市周":i<2*t?"招募周":"宝箱周"}),isWeirdTowerActivityOpen=computed(()=>getCurrentActivityWeek.value==="黑市周"),selectedTokens=ref([]),tokenStatus=ref({}),isRunning=ref(!1),shouldStop=ref(!1),showSettingsModal=ref(!1),currentSettingsTokenId=ref(null),currentSettingsTokenName=ref(""),currentSettings=reactive({arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0}),showTaskTemplateModal=ref(!1),showApplyTemplateModal=ref(!1),showTemplateManagerModal=ref(!1),showAccountTemplateModal=ref(!1),taskTemplates=ref([]),selectedTemplateId=ref(null),selectedTokensForApply=ref([]),currentTemplateName=ref(""),currentTemplateId=ref(null),currentTemplate=reactive({arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0}),accountTemplateReferences=ref([]),filteredAccountTemplates=ref([]),selectedTemplateForFilter=ref(null),isAllSelectedForApply=computed(()=>selectedTokensForApply.value.length===sortedTokens.value.length&&sortedTokens.value.length>0),isIndeterminateForApply=computed(()=>selectedTokensForApply.value.length>0&&selectedTokensForApply.value.length<sortedTokens.value.length),filteredTaskTemplates=computed(()=>taskTemplates.value),showHelperModal=ref(!1),helperType=ref("box"),helperSettings=reactive({boxType:2001,fishType:1,count:100}),helperModalTitle=computed(()=>({box:"批量开宝箱",fish:"批量钓鱼",recruit:"批量招募"})[helperType.value]||"批量助手"),showBatchSettingsModal=ref(!1),batchSettings=reactive({boxCount:100,fishCount:100,recruitCount:100,defaultBoxType:2001,defaultFishType:1,receiverId:"",password:"",hideScheduledTasksModule:!1,tokenListColumns:2,commandDelay:500,taskDelay:500,maxActive:2,carMinColor:4,connectionTimeout:1e4,reconnectDelay:1e3}),loadBatchSettings=()=>{try{const a=localStorage.getItem("batchSettings");if(a){const e=JSON.parse(a);Object.assign(batchSettings,e)}}catch(a){console.error("Failed to load batch settings:",a)}},saveBatchSettings=()=>{try{localStorage.setItem("batchSettings",JSON.stringify(batchSettings)),message.success("定时批量任务设置已保存"),showBatchSettingsModal.value=!1}catch(a){console.error("Failed to save batch settings:",a),message.error("保存设置失败")}},openBatchSettings=()=>{loadBatchSettings(),showBatchSettingsModal.value=!0};loadBatchSettings();const showLegacyGiftModal=ref(!1),recipientIdInput=ref(""),recipientIdError=ref(""),recipientInfo=ref(null),isQueryingRecipient=ref(!1),giftQuantity=ref(10),securityPassword=ref(""),isAvatarLoading=ref(!1),avatarLoadError=ref(!1),scheduledTasks=ref([]),showTaskModal=ref(!1),showTasksModal=ref(!1),editingTask=ref(null),taskForm=reactive({name:"",runType:"daily",runTime:null,cronExpression:"",selectedTokens:[],selectedTasks:[],enabled:!0}),cronValidation=ref({valid:!0,message:""}),cronNextRuns=ref([]),availableTasks=[{label:"日常任务",value:"startBatch"},{label:"领取挂机",value:"claimHangUpRewards"},{label:"一键加钟",value:"batchAddHangUpTime"},{label:"重置罐子",value:"resetBottles"},{label:"一键领取罐子",value:"batchlingguanzi"},{label:"一键爬塔",value:"climbTower"},{label:"一键爬怪异塔",value:"climbWeirdTower"},{label:"一键答题",value:"batchStudy"},{label:"智能发车",value:"batchSmartSendCar"},{label:"一键收车",value:"batchClaimCars"},{label:"批量开箱",value:"batchOpenBox"},{label:"领取宝箱积分",value:"batchClaimBoxPointReward"},{label:"批量钓鱼",value:"batchFish"},{label:"批量招募",value:"batchRecruit"},{label:"一键宝库前3层",value:"batchbaoku13"},{label:"一键宝库4,5层",value:"batchbaoku45"},{label:"一键梦境",value:"batchmengjing"},{label:"一键俱乐部签到",value:"batchclubsign"},{label:"一键竞技场战斗3次",value:"batcharenafight"},{label:"一键钓鱼补齐",value:"batchTopUpFish"},{label:"一键竞技场补齐",value:"batchTopUpArena"},{label:"一键领取怪异塔免费道具",value:"batchClaimFreeEnergy"},{label:"一键购买四圣碎片",value:"legion_storebuygoods"},{label:"一键黑市采购",value:"store_purchase"},{label:"免费领取珍宝阁",value:"collection_claimfreereward"},{label:"批量领取功法残卷",value:"batchLegacyClaim"},{label:"批量赠送功法残卷",value:"batchLegacyGiftSendEnhanced"}],CarresearchItem=[20,21,22,23,24,26,28,30,32,34,36,38,40,42,44,47,50,53,56,59,62,65,68,71,74,78,82,86,90,94,99,104,109,114,119,126,133,140,147,154,163,172,181,190,199,210,221,232,243,369,393,422,457,498,548,607,678,763,865,1011],loadScheduledTasks=()=>{try{const a=localStorage.getItem("scheduledTasks");if(a){const e=JSON.parse(a);scheduledTasks.value=Array.isArray(e)?e:[]}else scheduledTasks.value=[]}catch(a){console.error("Failed to load scheduled tasks:",a),scheduledTasks.value=[]}},saveScheduledTasks=()=>{try{const a=JSON.stringify(scheduledTasks.value);localStorage.setItem("scheduledTasks",a);const e=localStorage.getItem("scheduledTasks")}catch(a){console.error("Failed to save scheduled tasks:",a)}},openTaskModal=()=>{editingTask.value=null,Object.assign(taskForm,{name:"",runType:"daily",runTime:void 0,cronExpression:"",selectedTokens:[],selectedTasks:[],enabled:!0}),showTaskModal.value=!0},editTask=a=>{editingTask.value=a;const e={...a};if(a.runType==="daily"&&a.runTime&&typeof a.runTime=="string"){const[t,s]=a.runTime.split(":").map(Number),n=new Date;e.runTime=new Date(n.getFullYear(),n.getMonth(),n.getDate(),t,s)}Object.assign(taskForm,e),showTaskModal.value=!0},validateCronExpression=a=>{if(!a)return{valid:!1,message:"Cron表达式不能为空"};const e=a.split(" ").filter(Boolean);if(e.length!==5)return{valid:!1,message:"Cron表达式必须包含5个字段：分 时 日 月 周"};const[t,s,n,i,r]=e,l=(d,p,y,f)=>{if(d==="*")return{valid:!0};if(d.includes("/")){const h=d.split("/");if(h.length!==2)return{valid:!1,message:`${f}字段步长格式错误`};const[S,L]=h,k=parseInt(L);if(isNaN(k)||k<=0)return{valid:!1,message:`${f}字段步长必须是正整数`};if(S!=="*")if(S.includes(",")){const T=S.split(",");for(const o of T)if(o.includes("-")){const b=o.split("-");if(b.length!==2)return{valid:!1,message:`${f}字段范围格式错误`};const[N,x]=b.map(Number);if(isNaN(N)||isNaN(x)||N<p||x>y||N>x)return{valid:!1,message:`${f}字段范围必须在${p}-${y}之间，且开始值小于等于结束值`}}else{const b=parseInt(o);if(isNaN(b)||b<p||b>y)return{valid:!1,message:`${f}字段必须在${p}-${y}之间`}}}else if(S.includes("-")){const T=S.split("-");if(T.length!==2)return{valid:!1,message:`${f}字段范围格式错误`};const[o,b]=T.map(Number);if(isNaN(o)||isNaN(b)||o<p||b>y||o>b)return{valid:!1,message:`${f}字段范围必须在${p}-${y}之间，且开始值小于等于结束值`}}else{const T=parseInt(S);if(isNaN(T)||T<p||T>y)return{valid:!1,message:`${f}字段必须在${p}-${y}之间`}}return{valid:!0}}if(d.includes(",")){const h=d.split(",");for(const S of h){const L=S.trim();if(L.includes("-")){const k=L.split("-");if(k.length!==2)return{valid:!1,message:`${f}字段范围格式错误`};const[T,o]=k.map(Number);if(isNaN(T)||isNaN(o)||T<p||o>y||T>o)return{valid:!1,message:`${f}字段范围必须在${p}-${y}之间，且开始值小于等于结束值`}}else{const k=parseInt(L);if(isNaN(k)||k<p||k>y)return{valid:!1,message:`${f}字段必须在${p}-${y}之间`}}}return{valid:!0}}if(d.includes("-")){const h=d.split("-");if(h.length!==2)return{valid:!1,message:`${f}字段范围格式错误`};const[S,L]=h.map(Number);return isNaN(S)||isNaN(L)||S<p||L>y||S>L?{valid:!1,message:`${f}字段范围必须在${p}-${y}之间，且开始值小于等于结束值`}:{valid:!0}}const w=parseInt(d);return isNaN(w)||w<p||w>y?{valid:!1,message:`${f}字段必须在${p}-${y}之间`}:{valid:!0}},c=l(t,0,59,"分钟");if(!c.valid)return c;const u=l(s,0,23,"小时");if(!u.valid)return u;const v=l(n,1,31,"日期");if(!v.valid)return v;const g=l(i,1,12,"月份");if(!g.valid)return g;const m=l(r,0,7,"星期");return m.valid?{valid:!0,message:"Cron表达式格式正确"}:m},parseCronExpression=a=>{const e=validateCronExpression(a);if(cronValidation.value=e,!e.valid){cronNextRuns.value=[];return}const t=a.split(" ").filter(Boolean),[s,n,i,r,l]=t,c=calculateNextRuns(s,n,i,r,l,5);cronNextRuns.value=c},calculateNextRuns=(a,e,t,s,n,i=5)=>{const r=new Date,l=[];let c=new Date(r);c.setMilliseconds(0),c.setSeconds(0),c.setMinutes(c.getMinutes()+1);const u=new Date(r);for(u.setFullYear(u.getFullYear()+1);l.length<i&&c<=u;){const v=parseCronField(a,0,59),g=parseCronField(e,0,23),m=parseCronField(t,1,31),d=parseCronField(s,1,12),p=parseCronField(n,0,7),y=v.includes(c.getMinutes()),f=g.includes(c.getHours()),w=m.includes(c.getDate()),h=d.includes(c.getMonth()+1),S=p.includes(c.getDay()),L=n!=="*",k=t!=="*";let T;if(L&&k?T=w||S:T=w&&S,y&&f&&T&&h){const o=c.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1});l.push(o),c.setMinutes(c.getMinutes()+1)}else c.setMinutes(c.getMinutes()+1)}return l},saveTask=()=>{var s;if(!taskForm.name){message.warning("请输入任务名称");return}if(taskForm.runType==="daily"&&!taskForm.runTime){message.warning("请选择运行时间");return}if(taskForm.runType==="cron"){if(!taskForm.cronExpression){message.warning("请输入Cron表达式");return}const n=validateCronExpression(taskForm.cronExpression);if(!n.valid){message.warning(n.message);return}}if(taskForm.selectedTokens.length===0){message.warning("请选择至少一个账号");return}if(taskForm.selectedTasks.length===0){message.warning("请选择至少一个任务");return}let a=null;taskForm.runType==="daily"&&taskForm.runTime&&(a=new Date(taskForm.runTime).toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit"}));const e={id:((s=editingTask.value)==null?void 0:s.id)||"task_"+Date.now(),name:taskForm.name,runType:taskForm.runType,runTime:a,cronExpression:taskForm.runType==="cron"?taskForm.cronExpression:"",selectedTokens:[...taskForm.selectedTokens],selectedTasks:[...taskForm.selectedTasks],enabled:taskForm.enabled};let t=!editingTask.value;if(editingTask.value){const n=scheduledTasks.value.findIndex(i=>i.id===editingTask.value.id);n!==-1&&(scheduledTasks.value[n]=e)}else scheduledTasks.value.push(e);saveScheduledTasks(),addTaskSaveLog(e,t),showTaskModal.value=!1,message.success("定时任务已保存")},deleteTask=a=>{const e=scheduledTasks.value.find(t=>t.id===a);e&&(scheduledTasks.value=scheduledTasks.value.filter(t=>t.id!==a),saveScheduledTasks(),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${e.name} 已删除 ===`,type:"info"}),message.success("定时任务已删除"))},toggleTaskEnabled=(a,e)=>{const t=scheduledTasks.value.find(s=>s.id===a);t&&(t.enabled=e,saveScheduledTasks(),message.success(`定时任务已${e?"启用":"禁用"}`),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${t.name} 已${e?"启用":"禁用"} ===`,type:"info"}))},addTaskSaveLog=(a,e)=>{addLog({time:new Date().toLocaleTimeString(),message:`=== ${e?"新增":"修改"}定时任务: ${a.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`运行类型: ${a.runType==="daily"?"每天固定时间":"Cron表达式"}`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`运行时间: ${a.runType==="daily"?a.runTime:a.cronExpression}`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`选中账号: ${a.selectedTokens.length} 个`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`选中任务: ${a.selectedTasks.length} 个`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`状态: ${a.enabled?"启用":"禁用"}`,type:"info"})},resetRunType=()=>{taskForm.runType==="daily"?taskForm.cronExpression="":taskForm.runTime=void 0},selectAllTokens=()=>{taskForm.selectedTokens=tokens.value.map(a=>a.id)},deselectAllTokens=()=>{taskForm.selectedTokens=[]},selectAllTasks=()=>{taskForm.selectedTasks=availableTasks.map(a=>a.value)},deselectAllTasks=()=>{taskForm.selectedTasks=[]},legion_storebuygoods=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始购买四圣碎片: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 发送购买请求...`,type:"info"});const s=await tokenStore.sendMessageWithPromise(e,"legion_storebuygoods",{id:6},5e3);await new Promise(n=>setTimeout(n,500)),s.error?s.error.includes("俱乐部商品购买数量超出上限")?addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 本周已购买过四圣碎片，跳过`,type:"info"}):s.error.includes("物品不存在")?(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 盐锭不足或未加入军团，购买失败`,type:"error"}),tokenStatus.value[e]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 购买失败: ${s.error}`,type:"error"}),tokenStatus.value[e]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 购买成功，获得四圣碎片`,type:"success"}),tokenStatus.value[e]="completed")}catch(s){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 购买过程出错: ${s.message}`,type:"error"}),tokenStatus.value[e]="failed"}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),currentRunningTokenId.value=null,isRunning.value=!1,shouldStop.value=!1},legionStoreBuySkinCoins=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始购买俱乐部5皮肤币: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 发送购买请求...`,type:"info"});let s=null;for(let n=0;n<5&&!shouldStop.value;n++)s=await tokenStore.sendMessageWithPromise(e,"legion_storebuygoods",{id:1},5e3),await new Promise(i=>setTimeout(i,500));s&&s.error?s.error.includes("俱乐部商品购买数量超出上限")?addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 本周已购买过皮肤币，跳过`,type:"info"}):s.error.includes("物品不存在")?(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 盐锭不足或未加入军团，购买失败`,type:"error"}),tokenStatus.value[e]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 购买失败: ${s.error}`,type:"error"}),tokenStatus.value[e]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 购买成功，获得皮肤币`,type:"success"}),tokenStatus.value[e]="completed")}catch(s){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 购买过程出错: ${s.message}`,type:"error"}),tokenStatus.value[e]="failed"}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),currentRunningTokenId.value=null,isRunning.value=!1,shouldStop.value=!1},collection_claimfreereward=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始免费领取珍宝阁: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 发送珍宝阁免费领取请求...`,type:"info"});const s=await tokenStore.sendMessageWithPromise(e,"collection_claimfreereward",{},5e3);await new Promise(n=>setTimeout(n,500)),s.error?(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 珍宝阁领取失败: ${s.error}`,type:"error"}),tokenStatus.value[e]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 珍宝阁领取成功`,type:"success"}),tokenStatus.value[e]="completed")}catch(s){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 珍宝阁领取过程出错: ${s.message}`,type:"error"}),tokenStatus.value[e]="failed"}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),currentRunningTokenId.value=null,isRunning.value=!1,shouldStop.value=!1},store_purchase=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始黑市一键采购: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 发送黑市采购请求...`,type:"info"});const s=await tokenStore.sendMessageWithPromise(e,"store_purchase",{},5e3);await new Promise(n=>setTimeout(n,500)),s.error?(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 黑市采购失败: ${s.error}`,type:"error"}),tokenStatus.value[e]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 黑市采购成功`,type:"success"}),tokenStatus.value[e]="completed")}catch(s){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 黑市采购过程出错: ${s.message}`,type:"error"}),tokenStatus.value[e]="failed"}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),currentRunningTokenId.value=null,isRunning.value=!1,shouldStop.value=!1},parseCronField=(a,e,t)=>{const s=new Set;if(a.includes(",")){const i=a.split(",");for(const r of i)parseCronField(r.trim(),e,t).forEach(c=>s.add(c));return Array.from(s)}if(a==="*"){for(let i=e;i<=t;i++)s.add(i);return Array.from(s)}if(a.includes("/")){const[i,r]=a.split("/"),l=parseInt(r);let c=e,u=t;if(i!=="*")if(i.includes("-")){const[v,g]=i.split("-").map(Number);c=v,u=g}else c=parseInt(i),u=t;for(let v=c;v<=u;v+=l)s.add(v);return Array.from(s)}if(a.includes("-")){const[i,r]=a.split("-").map(Number);for(let l=i;l<=r;l++)s.add(l);return Array.from(s)}const n=parseInt(a);return isNaN(n)||s.add(n),Array.from(s)},calculateNextExecutionTime=a=>{const e=new Date;if(a.runType==="daily"){const[t,s]=a.runTime.split(":").map(Number),n=new Date(e);return n.setHours(t,s,0,0),n<=e&&n.setDate(n.getDate()+1),n}else if(a.runType==="cron"){const t=a.cronExpression.split(" ").filter(Boolean);if(t.length<5)return null;const[s,n,i,r,l]=t,c=parseCronField(s,0,59),u=parseCronField(n,0,23),v=parseCronField(i,1,31),g=parseCronField(r,1,12),m=parseCronField(l,0,7);let d=new Date(e);d.setSeconds(0,0),d.setMinutes(d.getMinutes()+1);const p=new Date(e);for(p.setFullYear(p.getFullYear()+1);d<=p;){const y=d.getMinutes(),f=d.getHours(),w=d.getDate(),h=d.getMonth()+1,S=d.getDay(),L=c.includes(y),k=u.includes(f),T=v.includes(w),o=g.includes(h),b=m.includes(S),N=l!=="*",x=i!=="*";let M;if(N&&x?M=T||b:M=T&&b,L&&k&&M&&o)return d;d.setMinutes(d.getMinutes()+1)}return null}return null},formatTimeDifference=a=>{const e=Math.floor(a/1e3),t=Math.floor(e/60),s=Math.floor(t/60),n=Math.floor(s/24),i=s%24,r=t%60,l=e%60;let c="";return n>0&&(c+=`${n}天`),(i>0||n>0)&&(c+=`${i}小时`),(r>0||i>0||n>0)&&(c+=`${r}分`),c+=`${l}秒`,c},taskCountdowns=ref({}),nextExecutionTimes=ref({}),updateCountdowns=()=>{const a=Date.now();scheduledTasks.value.forEach(e=>{if((!nextExecutionTimes.value[e.id]||nextExecutionTimes.value[e.id]<=a)&&(nextExecutionTimes.value[e.id]=calculateNextExecutionTime(e)),nextExecutionTimes.value[e.id]){const t=nextExecutionTimes.value[e.id]-a;taskCountdowns.value[e.id]={remainingTime:Math.max(0,t),formatted:formatTimeDifference(Math.max(0,t)),isNearExecution:t<5*60*1e3}}})},shortestCountdownTask=computed(()=>{if(scheduledTasks.value.length===0)return null;let a=null,e=1/0;return scheduledTasks.value.forEach(t=>{const s=taskCountdowns.value[t.id];s&&s.remainingTime<e&&(e=s.remainingTime,a={task:t,countdown:s})}),a});let countdownInterval=null;const startCountdown=()=>{countdownInterval&&clearInterval(countdownInterval),updateCountdowns(),countdownInterval=setInterval(updateCountdowns,1e3)};loadScheduledTasks(),watch(scheduledTasks,a=>{nextExecutionTimes.value={},taskCountdowns.value={},updateCountdowns()},{deep:!0}),watch(()=>showTaskModal.value,a=>{a&&!taskForm.runTime&&(taskForm.runTime=void 0)}),onMounted(()=>{scheduleTaskExecution(),startCountdown(),loadTaskTemplates()}),onBeforeUnmount(()=>{countdownInterval&&(clearInterval(countdownInterval),countdownInterval=null)});const scheduleTaskExecution=()=>{addLog({time:new Date().toLocaleTimeString(),message:"=== 定时任务调度服务已启动 ===",type:"info"});const a=ref(null);let e=null;const t=()=>{if(a.value||(console.error(`[${new Date().toISOString()}] Task scheduler interval is not running, restarting...`),s()),isRunning.value){const i=Date.now()-10*60*1e3;e&&e<i&&(console.error(`[${new Date().toISOString()}] isRunning has been true for more than 10 minutes, resetting to false`),isRunning.value=!1,addLog({time:new Date().toLocaleTimeString(),message:"=== 检测到任务执行超时，已重置isRunning状态 ===",type:"warning"}))}},s=()=>{a.value&&clearInterval(a.value),a.value=setInterval(()=>{try{const n=new Date,i=n.toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),r=scheduledTasks.value.filter(l=>l.enabled);if(r.length===0)return;r.forEach(l=>{let c=!1,u="";if(l.runType==="daily"){const v=l.runTime,g=n.toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit"});c=g===v,u=`currentTime=${g}, taskTime=${v}, match=${c}`}else if(l.runType==="cron")try{const v=l.cronExpression.split(" ").filter(Boolean);if(v.length<5){console.error(`[${new Date().toISOString()}] Invalid cron expression: ${l.cronExpression}, must have at least 5 parts`),addLog({time:i,message:`=== 定时任务 ${l.name} 的Cron表达式无效: ${l.cronExpression}，必须包含至少5个字段 ===`,type:"error"});return}const[g,m,d,p,y]=v,f=parseCronField(g,0,59),w=parseCronField(m,0,23),h=parseCronField(d,1,31),S=parseCronField(p,1,12),L=parseCronField(y,0,7),k=f.includes(n.getMinutes()),T=w.includes(n.getHours()),o=h.includes(n.getDate()),b=S.includes(n.getMonth()+1),N=L.includes(n.getDay());c=k&&T&&o&&b&&N,u=`minute=${k}, hour=${T}, dayOfMonth=${o}, month=${b}, dayOfWeek=${N}`}catch(v){console.error(`[${new Date().toISOString()}] Error parsing cron expression ${l.cronExpression}:`,v),addLog({time:i,message:`=== 解析定时任务 ${l.name} 的Cron表达式失败: ${v.message} ===`,type:"error"});return}if(c){const v=`${l.id}_${n.getDate()}_${n.getHours()}_${n.getMinutes()}`;localStorage.getItem(`lastTaskExecution_${l.id}`)!==v?(localStorage.setItem(`lastTaskExecution_${l.id}`,v),e=Date.now(),executeScheduledTask(l)):addLog({time:i,message:`=== 任务 ${l.name} 本分钟内已执行，跳过 ===`,type:"info"})}})}catch(n){console.error(`[${new Date().toISOString()}] Error in task scheduler:`,n),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务调度服务发生错误: ${n.message} ===`,type:"error"})}},1e4)};s(),setInterval(t,5*60*1e3),t(),onBeforeUnmount(()=>{a.value&&(clearInterval(a.value),a.value=null),addLog({time:new Date().toLocaleTimeString(),message:"=== 定时任务调度服务已停止 ===",type:"info"})})},verifyTaskDependencies=async task=>{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始验证定时任务 ${task.name} 的依赖 ===`,type:"info"});try{localStorage.setItem("test","test"),localStorage.removeItem("test"),addLog({time:new Date().toLocaleTimeString(),message:"✅ localStorage可用",type:"info"})}catch(a){return addLog({time:new Date().toLocaleTimeString(),message:`❌ localStorage不可用: ${a.message}`,type:"error"}),!1}if(!tokenStore||!tokenStore.gameTokens)return addLog({time:new Date().toLocaleTimeString(),message:"❌ Token存储不可用",type:"error"}),!1;for(const taskName of task.selectedTasks){const taskFunction=eval(taskName);if(typeof taskFunction!="function")return addLog({time:new Date().toLocaleTimeString(),message:`❌ 任务函数不存在: ${taskName}`,type:"error"}),!1}const connectedTokens=task.selectedTokens.map(a=>{var t;const e=((t=tokenStore.gameTokens.find(s=>s.id===a))==null?void 0:t.name)||a;return{id:a,name:e}});return addLog({time:new Date().toLocaleTimeString(),message:`✅ 将使用 ${connectedTokens.length} 个账号执行任务`,type:"info"}),task.connectedTokens=connectedTokens.map(a=>a.id),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${task.name} 的依赖验证通过，将执行 ${connectedTokens.length} 个账号 ===`,type:"success"}),!0},executeScheduledTask=async task=>{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始执行定时任务: ${task.name} ===`,type:"info"});try{const dependenciesValid=await verifyTaskDependencies(task);if(!dependenciesValid){addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${task.name} 依赖验证失败，取消执行 ===`,type:"error"});return}selectedTokens.value=[...task.connectedTokens||task.selectedTokens];const taskPromises=task.selectedTasks.map(async taskName=>{var a;if(shouldStop.value)return;addLog({time:new Date().toLocaleTimeString(),message:`执行任务: ${((a=availableTasks.find(e=>e.value===taskName))==null?void 0:a.label)||taskName}`,type:"info"});const taskFunction=eval(taskName);typeof taskFunction=="function"?["batchOpenBox","batchFish","batchRecruit","batchLegacyGiftSendEnhanced"].includes(taskName)?await taskFunction(!0):await taskFunction():addLog({time:new Date().toLocaleTimeString(),message:`任务函数不存在: ${taskName}`,type:"error"})});await Promise.all(taskPromises),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务执行完成: ${task.name} ===`,type:"success"})}catch(a){addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务执行失败: ${a.message} ===`,type:"error"}),console.error(`[${new Date().toISOString()}] Error executing scheduled task ${task.name}:`,a)}},boxTypeOptions=[{label:"木质宝箱",value:2001},{label:"青铜宝箱",value:2002},{label:"黄金宝箱",value:2003},{label:"铂金宝箱",value:2004}],fishTypeOptions=[{label:"普通鱼竿",value:1},{label:"黄金鱼竿",value:2}],openHelperModal=a=>{helperType.value=a,showHelperModal.value=!0},clearRecipientError=()=>{recipientIdError.value=""},handleAvatarLoad=()=>{isAvatarLoading.value=!1,avatarLoadError.value=!1},handleAvatarError=()=>{isAvatarLoading.value=!1,avatarLoadError.value=!0},resetAvatarState=()=>{isAvatarLoading.value=!0,avatarLoadError.value=!1},queryRecipientInfo=async()=>{var s,n,i,r,l,c,u,v;if(!recipientIdInput.value||recipientIdInput.value===""){recipientIdError.value="请输入接收者ID";return}const a=Number(recipientIdInput.value);if(!Number.isInteger(a)||a<=0){recipientIdError.value="请输入有效的数字ID";return}if(selectedTokens.value.length===0){recipientIdError.value="请先选择要操作的角色";return}isQueryingRecipient.value=!0,recipientIdError.value="",recipientInfo.value=null,resetAvatarState();const e=selectedTokens.value[0],t=tokens.value.find(g=>g.id===e);addLog({time:new Date().toLocaleTimeString(),message:`=== 开始查询接收者信息: 使用账号 ${t.name} (ID: ${e}) ===`,type:"info"});try{addLog({time:new Date().toLocaleTimeString(),message:"正在建立WebSocket连接...",type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:"WebSocket连接成功",type:"success"}),addLog({time:new Date().toLocaleTimeString(),message:`正在发送查询命令，接收者ID: ${a}`,type:"info"});const g=await tokenStore.sendMessageWithPromise(e,"rank_getroleinfo",{bottleType:0,includeBottleTeam:!1,isSearch:!1,roleId:a},1e4);addLog({time:new Date().toLocaleTimeString(),message:"查询命令发送成功，正在处理响应...",type:"info"}),console.log("rank_getroleinfo 响应结果:",g);const m=(g==null?void 0:g.role)||(g==null?void 0:g.roleInfo);if(m){recipientInfo.value={roleId:m.roleId||((s=m.role)==null?void 0:s.roleId),name:m.name||((n=m.role)==null?void 0:n.name),avatarUrl:((i=g==null?void 0:g.roleInfo)==null?void 0:i.headImg)||(m==null?void 0:m.headImg)||((r=m==null?void 0:m.role)==null?void 0:r.headImg)||"",power:function(p){return(p/1e8).toFixed(2)}(m.power||((l=m.role)==null?void 0:l.power)||0),powerUnit:"亿",serverName:m.serverName||((c=m.role)==null?void 0:c.serverName)||"",legionName:((u=g==null?void 0:g.legionInfo)==null?void 0:u.name)||"",legionId:((v=g==null?void 0:g.legionInfo)==null?void 0:v.id)||0};const d=recipientInfo.value.name||"未知角色";addLog({time:new Date().toLocaleTimeString(),message:`=== 查询成功: 找到角色 ${d} (ID: ${recipientInfo.value.roleId})，战力: ${recipientInfo.value.power}${recipientInfo.value.powerUnit} ===`,type:"success"}),message.success("查询成功")}else{const d="未找到该角色信息";recipientIdError.value=d,addLog({time:new Date().toLocaleTimeString(),message:`=== 查询失败: ${d} ===`,type:"error"}),message.error(d)}}catch(g){console.error("查询接收者信息失败:",g);let m="查询失败",d="error";g.message.includes("连接失败")?m="WebSocket连接失败，请检查网络或账号状态":g.message.includes("timeout")||g.message.includes("超时")?(m="查询超时，请稍后重试",d="warning"):g.message.includes("200160")?m="功法系统未开启":m=`查询失败: ${g.message}`,recipientIdError.value=m,addLog({time:new Date().toLocaleTimeString(),message:`=== ${m} ===`,type:d}),message.error(m)}finally{isQueryingRecipient.value=!1,addLog({time:new Date().toLocaleTimeString(),message:"=== 查询操作完成 ===",type:"info"})}},confirmLegacyGift=async()=>{if(!recipientIdInput.value||!recipientInfo.value){message.error("请先查询并确认接收者信息");return}if(!securityPassword.value){message.error("请输入安全密码");return}await batchLegacyGiftSendEnhanced(),showLegacyGiftModal.value=!1,securityPassword.value=""},executeHelper=()=>{if(helperSettings.count%10!==0||helperSettings.count<10){message.warning("消耗数量必须是10的整数倍，最小为10");return}showHelperModal.value=!1,helperType.value==="box"?batchOpenBox():helperType.value==="fish"?batchFish():helperType.value==="recruit"&&batchRecruit()},formationOptions=[1,2,3,4,5,6].map(a=>({label:`阵容${a}`,value:a})),bossTimesOptions=[0,1,2,3,4].map(a=>({label:`${a}次`,value:a})),loadSettings=a=>{try{const e=localStorage.getItem(`daily-settings:${a}`),t={arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0};return e?{...t,...JSON.parse(e)}:t}catch(e){return console.error("Failed to load settings:",e),null}},openSettings=a=>{currentSettingsTokenId.value=a.id,currentSettingsTokenName.value=a.name;const e=loadSettings(a.id);Object.assign(currentSettings,e),showSettingsModal.value=!0},saveSettings=()=>{currentSettingsTokenId.value&&(localStorage.setItem(`daily-settings:${currentSettingsTokenId.value}`,JSON.stringify(currentSettings)),message.success(`已保存 ${currentSettingsTokenName.value} 的设置`),showSettingsModal.value=!1)},loadTaskTemplates=()=>{const a=localStorage.getItem("task-templates"),e=a?JSON.parse(a):[];return taskTemplates.value=e,e},openApplyTemplateModal=()=>{loadTaskTemplates(),selectedTemplateId.value=null,selectedTokensForApply.value=[],showApplyTemplateModal.value=!0},handleSelectAllForApply=a=>{a?selectedTokensForApply.value=sortedTokens.value.map(e=>e.id):selectedTokensForApply.value=[]},applyTemplate=()=>{if(!selectedTemplateId.value||selectedTokensForApply.value.length===0){message.error("请选择模板和要应用的账号");return}const e=loadTaskTemplates().find(s=>s.id===selectedTemplateId.value);if(!e){message.error("模板不存在");return}let t=0;selectedTokensForApply.value.forEach(s=>{const n={...e.settings,templateId:e.id};localStorage.setItem(`daily-settings:${s}`,JSON.stringify(n)),t++}),message.success(`已成功应用模板到 ${t} 个账号`),showApplyTemplateModal.value=!1},openTemplateManagerModal=()=>{loadTaskTemplates(),showTemplateManagerModal.value=!0},openEditTemplateModal=a=>{currentTemplateId.value=a.id,currentTemplateName.value=a.name,Object.assign(currentTemplate,a.settings),showTaskTemplateModal.value=!0},updateTaskTemplate=()=>{if(!currentTemplateName.value.trim()){message.error("请输入模板名称");return}const a=loadTaskTemplates(),e=a.findIndex(t=>t.id===currentTemplateId.value);if(e===-1){message.error("模板不存在");return}a[e]={...a[e],name:currentTemplateName.value.trim(),settings:{...currentTemplate},updatedAt:new Date().toISOString()},localStorage.setItem("task-templates",JSON.stringify(a)),taskTemplates.value=a,message.success(`已更新模板 "${a[e].name}"`),showTaskTemplateModal.value=!1,resetTemplateForm()},deleteTaskTemplate=a=>{if(confirm("确定要删除这个模板吗？")){const t=loadTaskTemplates().filter(s=>s.id!==a);localStorage.setItem("task-templates",JSON.stringify(t)),taskTemplates.value=t,message.success("模板已删除")}},resetTemplateForm=()=>{currentTemplateId.value=null,currentTemplateName.value="",Object.assign(currentTemplate,{arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0})},openAccountTemplateModal=()=>{loadAccountTemplateReferences(),showAccountTemplateModal.value=!0},loadAccountTemplateReferences=()=>{const a=loadTaskTemplates(),e=[];sortedTokens.value.forEach(t=>{const s=localStorage.getItem(`daily-settings:${t.id}`);if(s)try{const i=JSON.parse(s).templateId,r=a.find(l=>l.id===i);e.push({tokenId:t.id,tokenName:t.name,templateId:i,templateName:r?r.name:"未引用模板"})}catch(n){console.error(`解析账号 ${t.name} 的设置失败:`,n)}else e.push({tokenId:t.id,tokenName:t.name,templateId:null,templateName:"未引用模板"})}),accountTemplateReferences.value=e,filteredAccountTemplates.value=e},filterAccountTemplates=()=>{selectedTemplateForFilter.value?filteredAccountTemplates.value=accountTemplateReferences.value.filter(a=>a.templateId===selectedTemplateForFilter.value):filteredAccountTemplates.value=accountTemplateReferences.value},openNewTemplateModal=()=>{resetTemplateForm(),showTaskTemplateModal.value=!0},saveTaskTemplate=()=>{if(!currentTemplateName.value.trim()){message.error("请输入模板名称");return}const a=loadTaskTemplates();if(currentTemplateId.value)updateTaskTemplate();else{const e={id:Date.now().toString(),name:currentTemplateName.value.trim(),settings:{...currentTemplate},createdAt:new Date().toISOString()};a.push(e),localStorage.setItem("task-templates",JSON.stringify(a)),taskTemplates.value=a,message.success(`已保存模板 "${e.name}"`),showTaskTemplateModal.value=!1,resetTemplateForm()}},currentRunningTokenId=ref(null),currentProgress=ref(0),logs=ref([]),logContainer=ref(null),autoScrollLog=ref(!0),filterErrorsOnly=ref(!1),errorCount=computed(()=>logs.value.filter(a=>a.type==="error").length),filteredLogs=computed(()=>filterErrorsOnly.value?logs.value.filter(a=>a.type==="error"):logs.value),currentRunningTokenName=computed(()=>{const a=tokens.value.find(e=>e.id===currentRunningTokenId.value);return a?a.name:""}),isAllSelected=computed(()=>selectedTokens.value.length===tokens.value.length&&tokens.value.length>0),isIndeterminate=computed(()=>selectedTokens.value.length>0&&selectedTokens.value.length<tokens.value.length),handleSelectAll=a=>{a?selectedTokens.value=tokens.value.map(e=>e.id):selectedTokens.value=[]},getStatusType=a=>{const e=tokenStatus.value[a];return e==="completed"?"success":e==="failed"?"error":e==="running"?"info":"default"},getStatusText=a=>{const e=tokenStatus.value[a];return e==="completed"?"已完成":e==="failed"?"失败":e==="running"?"执行中":"等待中"},pickArenaTargetId=a=>{var t,s,n,i,r;const e=((t=a==null?void 0:a.rankList)==null?void 0:t[0])||((s=a==null?void 0:a.roleList)==null?void 0:s[0])||((n=a==null?void 0:a.targets)==null?void 0:n[0])||((i=a==null?void 0:a.targetList)==null?void 0:i[0])||((r=a==null?void 0:a.list)==null?void 0:r[0]);return e!=null&&e.roleId?e.roleId:e!=null&&e.id?e.id:(a==null?void 0:a.roleId)||(a==null?void 0:a.id)},getTodayStartSec=()=>{const a=new Date;return a.setHours(0,0,0,0),Math.floor(a.getTime()/1e3)},isTodayAvailable=a=>!a||typeof a!="number"?!0:a<getTodayStartSec(),calculateMonthProgress=()=>{const a=new Date,e=new Date(a.getFullYear(),a.getMonth()+1,0).getDate(),t=a.getDate();return Math.min(1,Math.max(0,t/e))},addLog=a=>{logs.value.push(a),nextTick(()=>{logContainer.value&&autoScrollLog.value&&(logContainer.value.scrollTop=logContainer.value.scrollHeight)})};watch(autoScrollLog,a=>{a&&logContainer.value&&nextTick(()=>{logContainer.value.scrollTop=logContainer.value.scrollHeight})});const copyLogs=()=>{if(logs.value.length===0){message.warning("没有可复制的日志");return}const a=logs.value.map(e=>`${e.time} ${e.message}`).join(`
`);navigator.clipboard.writeText(a).then(()=>{message.success("日志已复制到剪贴板")}).catch(e=>{message.error("复制日志失败: "+e.message)})},waitForConnection=async(a,e=batchSettings.connectionTimeout)=>{const t=Date.now();for(;Date.now()-t<e;){if(tokenStore.getWebSocketStatus(a)==="connected")return!0;await new Promise(n=>setTimeout(n,500))}return!1},resetBottles=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`=== 开始重置罐子: ${t.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 停止计时...`,type:"info"}),await tokenStore.sendMessageWithPromise(e,"bottlehelper_stop",{},5e3),await new Promise(s=>setTimeout(s,500)),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 开始计时...`,type:"info"}),await tokenStore.sendMessageWithPromise(e,"bottlehelper_start",{},5e3),tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 重置完成 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 重置失败: ${s.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量重置罐子结束")},claimHangUpRewards=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始领取挂机: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 领取挂机奖励`,type:"info"}),await tokenStore.sendMessageWithPromise(e,"system_claimhangupreward",{},5e3),await new Promise(s=>setTimeout(s,500));for(let s=0;s<4&&!shouldStop.value;s++)addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 挂机加钟 ${s+1}/4`,type:"info"}),await tokenStore.sendMessageWithPromise(e,"system_mysharecallback",{isSkipShareCard:!0,type:2},5e3),await new Promise(n=>setTimeout(n,500));tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 领取挂机奖励完成 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 领取挂机奖励失败: ${s.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取挂机结束")},batchbaoku13=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键宝库: ${t.name} ===`,type:"info"}),await ensureConnection(e);const n=(await tokenStore.sendMessageWithPromise(e,"bosstower_getinfo",{})).bossTower.towerId;if(n>=1&&n<=3){for(let i=0;i<2&&!shouldStop.value;i++)await tokenStore.sendMessageWithPromise(e,"bosstower_startboss",{}),await new Promise(r=>setTimeout(r,500));for(let i=0;i<9&&!shouldStop.value;i++)await tokenStore.sendMessageWithPromise(e,"bosstower_startbox",{}),await new Promise(r=>setTimeout(r,500))}tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 宝库战斗已完成，请上线手动领取奖励 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 宝库战斗失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量宝库结束")},batchbaoku45=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键宝库: ${t.name} ===`,type:"info"}),await ensureConnection(e);const n=(await tokenStore.sendMessageWithPromise(e,"bosstower_getinfo",{})).bossTower.towerId;if(n>=4&&n<=5)for(let i=0;i<2&&!shouldStop.value;i++)await tokenStore.sendMessageWithPromise(e,"bosstower_startboss",{}),await new Promise(r=>setTimeout(r,500));tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 宝库战斗已完成 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 宝库战斗失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量宝库结束")},batchmengjing=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{if(addLog({time:new Date().toLocaleTimeString(),message:`=== 开始咸王梦境: ${t.name} ===`,type:"info"}),await ensureConnection(e),shouldStop.value)return;const s={0:107},n=new Date().getDay();n===0||n===1||n===3||n===4?(await tokenStore.sendMessageWithPromise(e,"dungeon_selecthero",{battleTeam:s},5e3),await new Promise(i=>setTimeout(i,500)),tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 咸王梦境已完成 ===`,type:"success"})):addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 当前未在开放时间 ===`,type:"error"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 咸王梦境失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量梦境结束")},batchlingguanzi=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{if(addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键领取盐罐: ${t.name} ===`,type:"info"}),await ensureConnection(e),shouldStop.value)return;await tokenStore.sendMessageWithPromise(e,"bottlehelper_claim",{},5e3),await new Promise(s=>setTimeout(s,500)),tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 领取盐罐已完成 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 领取盐罐失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取盐罐结束")},batchclubsign=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{if(addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键俱乐部签到: ${t.name} ===`,type:"info"}),await ensureConnection(e),shouldStop.value)return;await tokenStore.sendMessageWithPromise(e,"legion_signin",{},5e3),await new Promise(s=>setTimeout(s,500)),tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 俱乐部签到已完成 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 俱乐部签到失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量俱乐部签到结束")},batcharenafight=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{if(addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键竞技场战斗: ${t.name} ===`,type:"info"}),await ensureConnection(e),shouldStop.value)return;for(let s=0;s<3&&!shouldStop.value;s++){await tokenStore.sendMessageWithPromise(e,"arena_startarea",{});let n;try{n=await tokenStore.sendMessageWithPromise(e,"arena_getareatarget",{})}catch(r){message.error(`获取竞技场目标失败：${r.message}`);break}const i=pickArenaTargetId(n);if(!i){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 未找到可用的竞技场目标: ${err.message||"未知错误"}`,type:"error"});break}try{await tokenStore.sendMessageWithPromise(e,"fight_startareaarena",{targetId:i}),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 竞技场战斗 ${s+1}/3`,type:"info"}),await new Promise(r=>setTimeout(r,500))}catch(r){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 竞技场对决失败: ${r.message||"未知错误"}`,type:"error"})}}await new Promise(s=>setTimeout(s,500)),tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 竞技场战斗已完成 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 一键竞技场战斗失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量竞技场战斗结束")},batchAddHangUpTime=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键加钟: ${t.name} ===`,type:"info"}),await ensureConnection(e);for(let s=0;s<4&&!shouldStop.value;s++)addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 执行加钟 ${s+1}/4`,type:"info"}),await tokenStore.sendMessageWithPromise(e,"system_mysharecallback",{isSkipShareCard:!0,type:2},5e3),await new Promise(n=>setTimeout(n,500));tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 加钟完成 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 加钟失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量加钟结束")},connectionQueue={active:0},waitForConnectionSlot=async()=>{for(;connectionQueue.active>=batchSettings.maxActive;)await new Promise(a=>setTimeout(a,1e3));connectionQueue.active++},releaseConnectionSlot=()=>{connectionQueue.active>0&&connectionQueue.active--},ensureConnection=async(a,e=2)=>{var i;const t=tokens.value.find(r=>r.id===a);if(!t)throw new Error(`Token not found: ${a}`);let n=tokenStore.getWebSocketStatus(a)==="connected";if(!n){if(await waitForConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`正在连接... (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"}),tokenStore.createWebSocketConnection(a,t.token,t.wsUrl),n=await waitForConnection(a),!n&&e>0){addLog({time:new Date().toLocaleTimeString(),message:"连接超时，尝试重连...",type:"warning"}),tokenStore.closeWebSocketConnection(a),await new Promise(l=>setTimeout(l,batchSettings.reconnectDelay)),addLog({time:new Date().toLocaleTimeString(),message:"正在重连...",type:"info"});const r=tokens.value.find(l=>l.id===a);tokenStore.createWebSocketConnection(a,r.token,r.wsUrl),n=await waitForConnection(a)}if(!n)throw releaseConnectionSlot(),new Error("连接失败 (重试后仍超时)")}try{await tokenStore.sendMessageWithPromise(a,"role_getroleinfo",{},5e3);const r=await tokenStore.sendMessageWithPromise(a,"fight_startlevel",{},5e3);(i=r==null?void 0:r.battleData)!=null&&i.version&&tokenStore.setBattleVersion(r.battleData.version)}catch(r){addLog({time:new Date().toLocaleTimeString(),message:`初始化数据失败: ${r.message}`,type:"warning"})}return!0},climbTower=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{var s,n,i,r,l,c,u,v,g;if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(m=>m.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始爬塔: ${t.name} ===`,type:"info"}),await ensureConnection(e),await tokenStore.sendMessageWithPromise(e,"tower_getinfo",{},5e3).catch(()=>{});let m=await tokenStore.sendGetRoleInfo(e),d=((n=(s=m==null?void 0:m.role)==null?void 0:s.tower)==null?void 0:n.energy)||0;addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 初始体力: ${d}`,type:"info"});let p=0;const y=100;let f=0;for(;d>0&&p<y&&!shouldStop.value;)try{await tokenStore.sendMessageWithPromise(e,"fight_starttower",{},5e3),p++,f=0,addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 爬塔第 ${p} 次`,type:"info"}),await new Promise(h=>setTimeout(h,2e3)),tokenStore.sendMessage(e,"tower_getinfo"),m=await tokenStore.sendGetRoleInfo(e);const w=(i=tokenStore.gameData)==null?void 0:i.roleInfo;d=((l=(r=w==null?void 0:w.role)==null?void 0:r.tower)==null?void 0:l.energy)??((u=(c=m==null?void 0:m.role)==null?void 0:c.tower)==null?void 0:u.energy)??0}catch(w){if(w.message&&w.message.includes("200400")){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 爬塔次数已用完 (200400)`,type:"info"});break}if(w.message&&w.message.includes("12200010")){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 能量不足`,type:"info"});break}if(f++,addLog({time:new Date().toLocaleTimeString(),message:`战斗出错: ${w.message} (重试 ${f}/3)`,type:"warning"}),f>=3){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连续失败次数过多，停止爬塔`,type:"error"});break}await new Promise(h=>setTimeout(h,2e3));try{m=await tokenStore.sendGetRoleInfo(e),d=((g=(v=m==null?void 0:m.role)==null?void 0:v.tower)==null?void 0:g.energy)||0}catch{}}tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 爬塔结束，共 ${p} 次 ===`,type:"success"})}catch(m){console.error(m),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 爬塔失败: ${m.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量爬塔结束")},climbWeirdTower=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,currentRunningTokenId.value=null,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running",currentRunningTokenId.value=e;const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始爬怪异塔: ${t.name} ===`,type:"info"}),await ensureConnection(e),await tokenStore.sendMessageWithPromise(e,"evotower_getinfo",{},5e3).catch(()=>{}),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 开始爬怪异塔`,type:"info"});let s=0;const n=100;let i=0,r=!1;for(;s<n&&!shouldStop.value&&!r;)try{await tokenStore.sendMessageWithPromise(e,"evotower_getinfo",{},5e3).catch(()=>{}),await tokenStore.sendMessageWithPromise(e,"evotower_readyfight",{},5e3);const l=await tokenStore.sendMessageWithPromise(e,"evotower_fight",{battleNum:1,winNum:1},1e4);if(s++,i=0,addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 爬怪异塔第 ${s} 次`,type:"info"}),l&&l.winList&&l.winList[0]===!0){const c=await tokenStore.sendMessageWithPromise(e,"evotower_getinfo",{},5e3).catch(()=>{});if(c&&c.evoTower){const u=c.evoTower.towerId||0;u%10+1===1&&(await tokenStore.sendMessageWithPromise(e,"evotower_claimreward",{},5e3),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 成功领取第${Math.floor(u/10)}章通关奖励！`,type:"success"}))}}await new Promise(c=>setTimeout(c,400))}catch(l){let c=l.message;if(l.message&&l.message.includes("12200010")&&(c="能量不足"),c&&(c.includes("能量不足")||c.includes("模块未开启"))){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} ${c}，停止爬怪异塔`,type:"info"}),r=!0;break}if(i++,addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 战斗出错: ${l.message} (重试 ${i}/3)`,type:"warning"}),i>=3){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连续失败次数过多，停止爬怪异塔`,type:"error"});break}await new Promise(u=>setTimeout(u,2e3))}try{const l=await tokenStore.sendMessageWithPromise(e,"mergebox_getinfo",{actType:1},5e3);l&&l.mergeBox.freeEnergy>0&&(await tokenStore.sendMessageWithPromise(e,"mergebox_claimfreeenergy",{actType:1},5e3),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 成功领取免费道具${l.mergeBox.freeEnergy}个！`,type:"success"}))}catch{}tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 爬怪异塔结束，共 ${s} 次 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 爬怪异塔失败: ${s.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量爬怪异塔结束")},batchStudy=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"}),addLog({time:new Date().toLocaleTimeString(),message:"正在加载题库...",type:"info"}),await preloadQuestions();const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始答题: ${t.name} ===`,type:"info"}),await ensureConnection(e),tokenStore.gameData.studyStatus={isAnswering:!1,questionCount:0,answeredCount:0,status:"",timestamp:null},await tokenStore.sendMessageWithPromise(e,"study_startgame",{},5e3);let s=90,n=!1,i="";for(;s>0&&!shouldStop.value;){const r=tokenStore.gameData.studyStatus;if(r.status!==i&&(i=r.status,r.status==="answering"?addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 开始答题...`,type:"info"}):r.status==="claiming_rewards"&&addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 领取奖励...`,type:"info"})),r.status==="answering"&&r.questionCount>0,r.status==="completed"){n=!0;break}await new Promise(l=>setTimeout(l,1e3)),s--}n?(tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 答题完成 ===`,type:"success"})):shouldStop.value?addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 已停止`,type:"warning"}):(tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 答题超时或未开始`,type:"error"}))}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`答题失败: ${s.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量答题结束")},batchTopUpFish=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{var s,n,i,r,l,c,u,v,g;if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(m=>m.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始钓鱼补齐: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 获取月度任务进度...`,type:"info"});const m=await tokenStore.sendMessageWithPromise(e,"activity_get",{},1e4),d=(m==null?void 0:m.activity)||((s=m==null?void 0:m.body)==null?void 0:s.activity)||m;if(!d){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 获取月度任务进度失败`,type:"error"}),tokenStatus.value[e]="failed";return}const p=d.myMonthInfo||{},y=Number(((n=p==null?void 0:p["2"])==null?void 0:n.num)||0),f=calculateMonthProgress(),w=new Date,h=new Date(w.getFullYear(),w.getMonth()+1,0).getDate(),S=w.getDate(),k=Math.max(0,h-S)===0?FISH_TARGET:Math.min(FISH_TARGET,Math.ceil(f*FISH_TARGET)),T=Math.max(0,k-y);if(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 当前进度: ${y}/${FISH_TARGET}，需要补齐: ${T}次`,type:"info"}),T<=0){addLog({time:new Date().toLocaleTimeString(),message:"当前进度已达标，无需补齐",type:"success"}),tokenStatus.value[e]="completed";return}addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 开始执行钓鱼补齐...`,type:"info"});let o=(r=(i=tokenStore.gameData)==null?void 0:i.roleInfo)==null?void 0:r.role;if(!o)try{const V=await tokenStore.sendGetRoleInfo(e);o=V==null?void 0:V.role}catch{}let b=0;const N=Number(((l=o==null?void 0:o.statisticsTime)==null?void 0:l["artifact:normal:lottery:time"])||0);if(isTodayAvailable(N)){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 检测到今日免费钓鱼次数，开始消耗 3 次`,type:"info"});for(let V=0;V<3&&T>b&&!shouldStop.value;V++)try{await tokenStore.sendMessageWithPromise(e,"artifact_lottery",{lotteryNumber:1,newFree:!0,type:1},8e3),b++,await new Promise(B=>setTimeout(B,500))}catch(B){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 免费钓鱼失败: ${B.message}`,type:"error"});break}}const x=await tokenStore.sendMessageWithPromise(e,"activity_get",{},1e4),D=((x==null?void 0:x.activity)||((c=x==null?void 0:x.body)==null?void 0:c.activity)||x).myMonthInfo||{},A=Number(((u=D==null?void 0:D["2"])==null?void 0:u.num)||0);let $=Math.max(0,k-A);if(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 免费次数后进度: ${A}/${FISH_TARGET}，还需补齐: ${$}次`,type:"info"}),$<=0){addLog({time:new Date().toLocaleTimeString(),message:"已通过免费次数完成目标",type:"success"}),tokenStatus.value[e]="completed";return}for(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 开始付费钓鱼补齐: 共需 ${$} 次（每次最多10）`,type:"info"});$>0&&!shouldStop.value;){const V=Math.min(10,$);try{await tokenStore.sendMessageWithPromise(e,"artifact_lottery",{lotteryNumber:V,newFree:!0,type:1},12e3),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 完成 ${V} 次付费钓鱼`,type:"info"}),$-=V,await new Promise(B=>setTimeout(B,800))}catch(B){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 付费钓鱼失败: ${B.message}`,type:"error"});break}}const C=await tokenStore.sendMessageWithPromise(e,"activity_get",{},1e4),_=((C==null?void 0:C.activity)||((v=C==null?void 0:C.body)==null?void 0:v.activity)||C).myMonthInfo||{},R=Number(((g=_==null?void 0:_["2"])==null?void 0:g.num)||0);R>=k||R>=FISH_TARGET?addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 钓鱼补齐完成，最终进度: ${R}/${FISH_TARGET}`,type:"success"}):addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 钓鱼补齐已停止，未达到目标，最终进度: ${R}/${FISH_TARGET}`,type:"warning"}),tokenStatus.value[e]="completed"}catch(m){console.error(m),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 钓鱼补齐失败: ${m.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量钓鱼补齐结束")},batchTopUpArena=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{var s,n,i;if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(r=>r.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始竞技场补齐: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 获取月度任务进度...`,type:"info"});const r=await tokenStore.sendMessageWithPromise(e,"activity_get",{},1e4),l=(r==null?void 0:r.activity)||((s=r==null?void 0:r.body)==null?void 0:s.activity)||r;if(!l){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 获取月度任务进度失败`,type:"error"}),tokenStatus.value[e]="failed";return}const c=l.myArenaInfo||{},u=Number((c==null?void 0:c.num)||0),v=calculateMonthProgress(),g=new Date,m=new Date(g.getFullYear(),g.getMonth()+1,0).getDate(),d=g.getDate(),y=Math.max(0,m-d)===0?ARENA_TARGET:Math.min(ARENA_TARGET,Math.ceil(v*ARENA_TARGET)),f=Math.max(0,y-u);if(addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 当前进度: ${u}/${ARENA_TARGET}，需要补齐: ${f}次`,type:"info"}),f<=0){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 当前进度已达标，无需补齐`,type:"success"}),tokenStatus.value[e]="completed";return}addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 开始执行竞技场补齐...`,type:"info"});try{await tokenStore.sendMessageWithPromise(e,"arena_startarea",{},6e3)}catch(N){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 开始竞技场失败: ${N.message}`,type:"warning"})}let w=0;const h=100;let S=1,L=f;for(;L>0&&w<h&&!shouldStop.value;){const N=Math.ceil(L/2);addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 第${S}轮：计划战斗 ${N} 场`,type:"info"});for(let $=0;$<N&&w<h&&!shouldStop.value;$++){let C;try{C=await tokenStore.sendMessageWithPromise(e,"arena_getareatarget",{},8e3)}catch(_){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 获取竞技场目标失败：${_.message}`,type:"error"});break}const P=pickArenaTargetId(C);if(!P){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 未找到可用的竞技场目标`,type:"warning"});break}try{await tokenStore.sendMessageWithPromise(e,"fight_startareaarena",{targetId:P},15e3),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 竞技场战斗 ${$+1}/${N} 完成`,type:"info"})}catch(_){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 竞技场对决失败：${_.message}`,type:"error"})}w++,await new Promise(_=>setTimeout(_,1200))}const x=await tokenStore.sendMessageWithPromise(e,"activity_get",{},1e4),D=((x==null?void 0:x.activity)||((n=x==null?void 0:x.body)==null?void 0:n.activity)||x).myArenaInfo||{},A=Number((D==null?void 0:D.num)||0);L=Math.max(0,y-A),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 第${S}轮后进度: ${A}/${ARENA_TARGET}，还需补齐: ${L}次`,type:"info"}),S++}const k=await tokenStore.sendMessageWithPromise(e,"activity_get",{},1e4),o=((k==null?void 0:k.activity)||((i=k==null?void 0:k.body)==null?void 0:i.activity)||k).myArenaInfo||{},b=Number((o==null?void 0:o.num)||0);b>=y||b>=ARENA_TARGET?addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 竞技场补齐完成，最终进度: ${b}/${ARENA_TARGET}`,type:"success"}):w>=h?addLog({time:new Date().toLocaleTimeString(),message:`达到安全上限，竞技场补齐已停止，最终进度: ${b}/${ARENA_TARGET}`,type:"warning"}):addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 竞技场补齐已停止，未达到目标，最终进度: ${b}/${ARENA_TARGET}`,type:"warning"}),tokenStatus.value[e]="completed"}catch(r){console.error(r),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 竞技场补齐失败: ${r.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量竞技场补齐结束")},normalizeCars=a=>{const e=a||{},t=e.body||e,s=t.roleCar||t.rolecar||{},n=s.carDataMap||s.cardatamap;if(n&&typeof n=="object")return Object.entries(n).map(([r,l],c)=>({key:c,id:r,...l||{}}));let i=t.cars||t.list||t.data||t.carList||t.vehicles||[];return!Array.isArray(i)&&typeof i=="object"&&i!==null&&(i=Object.values(i)),Array.isArray(t)&&i.length===0&&(i=t),(Array.isArray(i)?i:[]).map((r,l)=>({key:l,...r}))},gradeLabel=a=>({1:"绿·普通",2:"蓝·稀有",3:"紫·史诗",4:"橙·传说",5:"红·神话",6:"金·传奇"})[a]||"未知",isBigPrize=a=>{const e=[{type:3,itemId:3201,value:10},{type:3,itemId:1001,value:10},{type:3,itemId:1022,value:2e3},{type:2,itemId:0,value:2e3},{type:3,itemId:1023,value:5},{type:3,itemId:1022,value:2500},{type:3,itemId:1001,value:12}];return Array.isArray(a)?e.some(t=>a.find(s=>s.type===t.type&&s.itemId===t.itemId&&Number(s.value||0)>=t.value)):!1},countRacingRefreshTickets=a=>Array.isArray(a)?a.reduce((e,t)=>e+(t.type===3&&t.itemId===35002?Number(t.value||0):0),0):0,shouldSendCar=(a,e)=>{const t=Number((a==null?void 0:a.color)||0),s=Array.isArray(a==null?void 0:a.rewards)?a.rewards:[],n=countRacingRefreshTickets(s),i=batchSettings.carMinColor||4;return e>=6?t>=i&&(t>=5||n>=4||isBigPrize(s)):t>=i||n>=2||isBigPrize(s)},canClaim=a=>{const e=Number((a==null?void 0:a.sendAt)||0);if(!e)return!1;const t=e<1e12?e*1e3:e;return Date.now()-t>=FOUR_HOURS_MS},batchSmartSendCar=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{var s,n,i,r,l,c,u;if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(v=>v.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始智能发车: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 获取车辆信息...`,type:"info"});const v=await tokenStore.sendMessageWithPromise(e,"car_getrolecar",{},1e4);let g=normalizeCars((v==null?void 0:v.body)??v),m=0;try{const d=await tokenStore.sendMessageWithPromise(e,"role_getroleinfo",{},1e4),p=(i=(n=(s=d==null?void 0:d.role)==null?void 0:s.items)==null?void 0:n[35002])==null?void 0:i.quantity;m=Number(p||0),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 剩余刷新次数: ${m}`,type:"info"})}catch{}for(const d of g){if(shouldStop.value)break;if(Number(d.sendAt||0)===0)try{if(shouldSendCar(d,m)){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 车辆[${gradeLabel(d.color)}]满足条件，直接发车`,type:"info"}),await tokenStore.sendMessageWithPromise(e,"car_send",{carId:String(d.id),helperId:0,text:"",isUpgrade:!1},1e4),await new Promise(f=>setTimeout(f,500));continue}let p=!1;const y=Number(d.refreshCount??0)===0;if(m>=6)p=!0;else if(y)p=!0;else{addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 车辆[${gradeLabel(d.color)}]不满足条件且无刷新次数，直接发车`,type:"warning"}),await tokenStore.sendMessageWithPromise(e,"car_send",{carId:String(d.id),helperId:0,text:"",isUpgrade:!1},1e4),await new Promise(f=>setTimeout(f,500));continue}for(;p&&!shouldStop.value;){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 车辆[${gradeLabel(d.color)}]尝试刷新...`,type:"info"});const f=await tokenStore.sendMessageWithPromise(e,"car_refresh",{carId:String(d.id)},1e4),w=(f==null?void 0:f.car)||((r=f==null?void 0:f.body)==null?void 0:r.car)||f;w&&typeof w=="object"&&(w.color!=null&&(d.color=Number(w.color)),w.refreshCount!=null&&(d.refreshCount=Number(w.refreshCount)),w.rewards!=null&&(d.rewards=w.rewards));try{const S=await tokenStore.sendMessageWithPromise(e,"role_getroleinfo",{},5e3);m=Number(((u=(c=(l=S==null?void 0:S.role)==null?void 0:l.items)==null?void 0:c[35002])==null?void 0:u.quantity)||0)}catch{}if(shouldSendCar(d,m)){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 刷新后车辆[${gradeLabel(d.color)}]满足条件，发车`,type:"success"}),await tokenStore.sendMessageWithPromise(e,"car_send",{carId:String(d.id),helperId:0,text:"",isUpgrade:!1},1e4),await new Promise(S=>setTimeout(S,500));break}const h=Number(d.refreshCount??0)===0;if(m>=6)p=!0;else if(h)p=!0;else{addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 刷新后车辆[${gradeLabel(d.color)}]仍不满足条件且无刷新次数，发车`,type:"warning"}),await tokenStore.sendMessageWithPromise(e,"car_send",{carId:String(d.id),helperId:0,text:"",isUpgrade:!1},1e4),await new Promise(S=>setTimeout(S,500));break}await new Promise(S=>setTimeout(S,1e3))}}catch(p){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 车辆[${gradeLabel(d.color)}]处理失败: ${p.message}，跳过该车辆`,type:"error"});continue}}tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 智能发车完成 ===`,type:"success"})}catch(v){console.error(v),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`智能发车失败: ${v.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量智能发车结束")},batchClaimCars=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{var s,n,i,r,l,c,u,v;if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(g=>g.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键收车: ${t.name} ===`,type:"info"}),await ensureConnection(e),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 获取车辆信息...`,type:"info"});const g=await tokenStore.sendMessageWithPromise(e,"car_getrolecar",{},1e4);let m=normalizeCars((g==null?void 0:g.body)??g),d=((n=(s=g==null?void 0:g.roleCar)==null?void 0:s.research)==null?void 0:n[1])||0,p=0;for(const y of m){if(shouldStop.value)break;if(canClaim(y)){try{await tokenStore.sendMessageWithPromise(e,"car_claim",{carId:String(y.id)},1e4),p++,addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 收车成功: ${gradeLabel(y.color)}`,type:"success"});const f=await tokenStore.sendMessageWithPromise(e,"role_getroleinfo",{},5e3);let w=Number(((l=(r=(i=f==null?void 0:f.role)==null?void 0:i.items)==null?void 0:r[35009])==null?void 0:l.quantity)||0);for(;d<CarresearchItem.length&&w>=CarresearchItem[d]&&!shouldStop.value;)try{await tokenStore.sendMessageWithPromise(e,"car_research",{researchId:1},5e3),d++;const h=await tokenStore.sendMessageWithPromise(e,"role_getroleinfo",{},5e3);w=Number(((v=(u=(c=h==null?void 0:h.role)==null?void 0:c.items)==null?void 0:u[35009])==null?void 0:v.quantity)||0),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 执行车辆改装升级，当前等级: ${d}`,type:"success"}),await new Promise(S=>setTimeout(S,300))}catch(h){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 车辆改装升级失败: ${h.message}`,type:"error"});break}}catch(f){addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 收车失败: ${f.message}`,type:"warning"})}await new Promise(f=>setTimeout(f,300))}}p===0&&addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 没有可收取的车辆`,type:"info"}),tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 收车完成，共收取 ${p} 辆 ===`,type:"success"})}catch(g){console.error(g),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 收车失败: ${g.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量一键收车结束")},startBatch=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";let t=0;const s=1;let n=!1;for(;t<=s&&!n&&!shouldStop.value;){const i=tokens.value.find(r=>r.id===e);try{addLog(t===0?{time:new Date().toLocaleTimeString(),message:`=== 开始执行: ${i.name} ===`,type:"info"}:{time:new Date().toLocaleTimeString(),message:`=== 尝试重试: ${i.name} (第${t}次) ===`,type:"info"}),await ensureConnection(e),await new DailyTaskRunner(tokenStore,{commandDelay:batchSettings.commandDelay,taskDelay:batchSettings.taskDelay}).run(e,{onLog:l=>addLog(l),onProgress:l=>{}}),n=!0,tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${i.name} 执行完成 ===`,type:"success"})}catch(r){console.error(r),t<s&&!shouldStop.value?(addLog({time:new Date().toLocaleTimeString(),message:`${i.name} 执行出错: ${r.message}，等待3秒后重试...`,type:"warning"}),await new Promise(l=>setTimeout(l,3e3)),t++):(tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`${i.name} 执行失败: ${r.message}`,type:"error"}))}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${i.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}}});await Promise.all(a),await new Promise(e=>setTimeout(e,1e3)),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量任务执行结束")},batchClaimBoxPointReward=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始领取宝箱积分: ${t.name} ===`,type:"info"}),await ensureConnection(e),await tokenStore.sendMessageWithPromise(e,"item_batchclaimboxpointreward",{},5e3),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 宝箱积分领取成功`,type:"success"}),await tokenStore.sendMessage(e,"role_getroleinfo"),tokenStatus.value[e]="completed",addLog({time:new Date().toLocaleTimeString(),message:`${t.name} === 领取完成 ===`,type:"success"})}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`领取失败: ${s.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取宝箱积分结束")},batchOpenBox=async(a=!1)=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1;const e=a?batchSettings.defaultBoxType:helperSettings.boxType,t=a?batchSettings.boxCount:helperSettings.count,s=Math.floor(t/10),n=t%10,i={2001:"木质宝箱",2002:"青铜宝箱",2003:"黄金宝箱",2004:"铂金宝箱"};selectedTokens.value.forEach(l=>{tokenStatus.value[l]="waiting"});const r=selectedTokens.value.map(async l=>{if(shouldStop.value)return;tokenStatus.value[l]="running";const c=tokens.value.find(u=>u.id===l);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始批量开箱: ${c.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`${c.name} 宝箱类型: ${i[e]}, 数量: ${t}`,type:"info"}),await ensureConnection(l);for(let u=0;u<s&&!shouldStop.value;u++)await tokenStore.sendMessageWithPromise(l,"item_openbox",{itemId:e,number:10},5e3),addLog({time:new Date().toLocaleTimeString(),message:`${c.name} 开箱进度: ${(u+1)*10}/${t}`,type:"info"}),await new Promise(v=>setTimeout(v,300));n>0&&!shouldStop.value&&(await tokenStore.sendMessageWithPromise(l,"item_openbox",{itemId:e,number:n},5e3),addLog({time:new Date().toLocaleTimeString(),message:`${c.name} 开箱进度: ${t}/${t}`,type:"info"})),await tokenStore.sendMessageWithPromise(l,"item_batchclaimboxpointreward"),await new Promise(u=>setTimeout(u,500)),await tokenStore.sendMessage(l,"role_getroleinfo"),tokenStatus.value[l]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${c.name} 开箱完成 ===`,type:"success"})}catch(u){console.error(u),tokenStatus.value[l]="failed",addLog({time:new Date().toLocaleTimeString(),message:`开箱失败: ${u.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(l),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${c.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(r),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量开箱结束")},batchFish=async(a=!1)=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1;const e=a?batchSettings.defaultFishType:helperSettings.fishType,t=a?batchSettings.fishCount:helperSettings.count,s=Math.floor(t/10),n=t%10,i={1:"普通鱼竿",2:"黄金鱼竿"};selectedTokens.value.forEach(l=>{tokenStatus.value[l]="waiting"});const r=selectedTokens.value.map(async l=>{if(shouldStop.value)return;tokenStatus.value[l]="running";const c=tokens.value.find(u=>u.id===l);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始批量钓鱼: ${c.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`${c.name} 鱼竿类型: ${i[e]}, 数量: ${t}`,type:"info"}),await ensureConnection(l);for(let u=0;u<s&&!shouldStop.value;u++)await tokenStore.sendMessageWithPromise(l,"artifact_lottery",{type:e,lotteryNumber:10,newFree:!0},5e3),addLog({time:new Date().toLocaleTimeString(),message:`${c.name} 钓鱼进度: ${(u+1)*10}/${t}`,type:"info"}),await new Promise(v=>setTimeout(v,300));n>0&&!shouldStop.value&&(await tokenStore.sendMessageWithPromise(l,"artifact_lottery",{type:e,lotteryNumber:n,newFree:!0},5e3),addLog({time:new Date().toLocaleTimeString(),message:`${c.name} 钓鱼进度: ${t}/${t}`,type:"info"})),await tokenStore.sendMessage(l,"role_getroleinfo"),tokenStatus.value[l]="completed",addLog({time:new Date().toLocaleTimeString(),message:`${c.name} === 钓鱼完成 ===`,type:"success"})}catch(u){console.error(u),tokenStatus.value[l]="failed",addLog({time:new Date().toLocaleTimeString(),message:`钓鱼失败: ${u.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(l),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${c.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(r),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量钓鱼结束")},batchRecruit=async(a=!1)=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1;const e=a?batchSettings.recruitCount:helperSettings.count,t=Math.floor(e/10),s=e%10;selectedTokens.value.forEach(i=>{tokenStatus.value[i]="waiting"});const n=selectedTokens.value.map(async i=>{if(shouldStop.value)return;tokenStatus.value[i]="running";const r=tokens.value.find(l=>l.id===i);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始批量招募: ${r.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`${r.name} 招募数量: ${e}`,type:"info"}),await ensureConnection(i);for(let l=0;l<t&&!shouldStop.value;l++)await tokenStore.sendMessageWithPromise(i,"hero_recruit",{recruitType:1,recruitNumber:10},5e3),addLog({time:new Date().toLocaleTimeString(),message:`招募进度: ${(l+1)*10}/${e}`,type:"info"}),await new Promise(c=>setTimeout(c,300));s>0&&!shouldStop.value&&(await tokenStore.sendMessageWithPromise(i,"hero_recruit",{recruitType:1,recruitNumber:s},5e3),addLog({time:new Date().toLocaleTimeString(),message:`招募进度: ${e}/${e}`,type:"info"})),await tokenStore.sendMessage(i,"role_getroleinfo"),tokenStatus.value[i]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${r.name} 招募完成 ===`,type:"success"})}catch(l){console.error(l),tokenStatus.value[i]="failed",addLog({time:new Date().toLocaleTimeString(),message:`招募失败: ${l.message}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(i),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${r.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(n),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量招募结束")},batchClaimFreeEnergy=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始领取怪异塔免费道具: ${t.name} ===`,type:"info"}),await ensureConnection(e);const s=await tokenStore.sendMessageWithPromise(e,"mergebox_getinfo",{actType:1},5e3);s&&s.mergeBox.freeEnergy>0?(await tokenStore.sendMessageWithPromise(e,"mergebox_claimfreeenergy",{actType:1},5e3),addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 成功领取免费道具${s.mergeBox.freeEnergy}个`,type:"success"})):addLog({time:new Date().toLocaleTimeString(),message:`===  ${t.name} 暂无免费道具可领取`,type:"success"}),tokenStatus.value[e]="completed"}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 领取免费道具失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取怪异塔免费道具结束")},batchLegacyClaim=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(e=>{tokenStatus.value[e]="waiting"});const a=selectedTokens.value.map(async e=>{if(shouldStop.value)return;tokenStatus.value[e]="running";const t=tokens.value.find(s=>s.id===e);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始领取功法残卷: ${t.name} ===`,type:"info"}),await ensureConnection(e);const s=await tokenStore.sendMessageWithPromise(e,"legacy_claimhangup",{},5e3);addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 成功领取功法残卷${s.reward[0].value}，共有${s.role.items[37007].quantity}个`,type:"success"}),tokenStatus.value[e]="completed"}catch(s){console.error(s),tokenStatus.value[e]="failed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${t.name} 领取功法残卷失败: ${s.message||"未知错误"}`,type:"error"})}finally{tokenStore.closeWebSocketConnection(e),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${t.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(a),isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取功法残卷结束")},batchLegacyGiftSendEnhanced=async(a=!1)=>{var l,c;if(selectedTokens.value.length===0){message.warning("请先选择要操作的角色");return}const e=a?batchSettings.receiverId:recipientIdInput.value,t=a?batchSettings.password:securityPassword.value,s={recipientId:Number(e),itemId:37007,quantity:giftQuantity.value||0,serverName:((l=recipientInfo.value)==null?void 0:l.serverName)||"",name:((c=recipientInfo.value)==null?void 0:c.name)||""};if(!a){if(!s.recipientId||s.recipientId<=0){message.error("请输入有效的接收者ID");return}if(s.quantity<=0||s.quantity>1e3){message.error("赠送数量必须在1-1000之间");return}}isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(u=>{tokenStatus.value[u]="waiting"});let n=0,i=0;const r=selectedTokens.value.map(async u=>{var d,p,y,f,w,h,S,L;if(shouldStop.value)return;tokenStatus.value[u]="running";const v=tokens.value.find(k=>k.id===u);let g=0;const m=2;for(;g<=m&&!shouldStop.value;)try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始赠送功法残卷: ${v.name} (尝试 ${g+1}/${m+1}) ===`,type:"info"}),await ensureConnection(u);const k=await tokenStore.sendGetRoleInfo(u),T=((y=(p=(d=k==null?void 0:k.role)==null?void 0:d.items)==null?void 0:p[s.itemId])==null?void 0:y.quantity)||0;if(a){if(T===0){addLog({time:new Date().toLocaleTimeString(),message:`=== ${v.name} 功法残卷不足，当前拥有: 0 ===`,type:"error"}),tokenStatus.value[u]="failed",i++;break}const N=await tokenStore.sendMessageWithPromise(u,"rank_getroleinfo",{bottleType:0,includeBottleTeam:!1,isSearch:!1,roleId:s.recipientId},5e3);if(s.serverName=((f=N==null?void 0:N.roleInfo)==null?void 0:f.serverName)||"",s.name=((w=N==null?void 0:N.roleInfo)==null?void 0:w.name)||"",!((h=N==null?void 0:N.roleInfo)!=null&&h.roleId)){addLog({time:new Date().toLocaleTimeString(),message:`=== ${v.name} 赠送功法残卷失败: 接收者${s.recipientId}不存在`,type:"error"}),tokenStatus.value[u]="failed",i++;break}s.quantity=T}if(T<s.quantity){addLog({time:new Date().toLocaleTimeString(),message:`=== ${v.name} 功法残卷不足，当前拥有: ${T}，需要: ${s.quantity} ===`,type:"error"}),tokenStatus.value[u]="failed",i++;break}addLog({time:new Date().toLocaleTimeString(),message:"=== 开始解除安全密码验证 ===",type:"info"});const o=await tokenStore.sendMessageWithPromise(u,"role_commitpassword",{password:t,passwordType:1},5e3);if(!o)throw new Error("安全密码验证请求无响应");if(!((L=(S=o.role)==null?void 0:S.statistics)!=null&&L["que:wh:tm"])){addLog({time:new Date().toLocaleTimeString(),message:`${v.name} === 密码解除失败,请检查密码是否配置正确 ===`,type:"error"}),tokenStatus.value[u]="failed",i++;break}if(addLog({time:new Date().toLocaleTimeString(),message:"=== 安全密码验证成功 ===",type:"success"}),addLog({time:new Date().toLocaleTimeString(),message:`${v.name} === 开始赠送功法残卷${s.quantity}个,目标:[${s.serverName}] ID:${s.recipientId} ${s.name} ===`,type:"info"}),!await tokenStore.sendMessageWithPromise(u,"legacy_sendgift",{itemCnt:s.quantity,legacyUIds:[],targetId:s.recipientId},5e3))throw new Error("赠送请求无响应");await tokenStore.sendMessage(u,"role_getroleinfo"),addLog({time:new Date().toLocaleTimeString(),message:`=== ${v.name} 成功赠送功法残卷${s.quantity}个给[${s.serverName}] ID:${s.recipientId} ${s.name} ===`,type:"success"}),tokenStatus.value[u]="completed",n++;break}catch(k){g++,console.error(`赠送失败: ${k.message}`);let T=k.message||"未知错误";if(T.includes("200160")?T="模块未开启":T.includes("timeout")?T="请求超时":T.includes("网络")&&(T="网络错误"),g<=m&&!shouldStop.value)addLog({time:new Date().toLocaleTimeString(),message:`=== ${v.name} 赠送功法残卷失败: ${T}，将在3秒后重试 ===`,type:"warning"}),await new Promise(o=>setTimeout(o,3e3));else{addLog({time:new Date().toLocaleTimeString(),message:`=== ${v.name} 赠送功法残卷失败: ${T}，已达最大重试次数 ===`,type:"error"}),tokenStatus.value[u]="failed",i++;break}}finally{tokenStore.closeWebSocketConnection(u),releaseConnectionSlot(),addLog({time:new Date().toLocaleTimeString(),message:`${v.name} 连接已关闭  (队列: ${connectionQueue.active}/${batchSettings.maxActive})`,type:"info"})}});await Promise.all(r),isRunning.value=!1,currentRunningTokenId.value=null,addLog({time:new Date().toLocaleTimeString(),message:`=== 批量赠送功法残卷完成: 成功 ${n} 个，失败 ${i} 个 ===`,type:"success"}),message.success(`批量赠送功法残卷结束，成功 ${n} 个，失败 ${i} 个`)},stopBatch=()=>{shouldStop.value=!0,addLog({time:new Date().toLocaleTimeString(),message:"正在停止...",type:"warning"})};return(a,e)=>{const t=resolveComponent("n-button"),s=resolveComponent("n-icon"),n=resolveComponent("n-space"),i=resolveComponent("n-button-group"),r=resolveComponent("n-checkbox"),l=resolveComponent("n-tag"),c=resolveComponent("n-grid-item"),u=resolveComponent("n-grid"),v=resolveComponent("n-checkbox-group"),g=resolveComponent("n-card"),m=resolveComponent("n-progress"),d=resolveComponent("n-select"),p=resolveComponent("n-switch"),y=resolveComponent("n-modal"),f=resolveComponent("n-input"),w=resolveComponent("n-text"),h=resolveComponent("n-input-number"),S=resolveComponent("n-radio"),L=resolveComponent("n-radio-group"),k=resolveComponent("n-time-picker"),T=resolveComponent("n-divider");return openBlock(),createElementBlock("div",_hoisted_1,[createBaseVNode("div",_hoisted_2,[createBaseVNode("div",_hoisted_3,[createBaseVNode("div",_hoisted_4,[createBaseVNode("div",_hoisted_5,[e[84]||(e[84]=createBaseVNode("h2",null,"批量日常任务",-1)),createBaseVNode("div",_hoisted_6,[createBaseVNode("div",_hoisted_7," 共 "+toDisplayString(scheduledTasks.value.length)+" 个定时任务 ",1),shortestCountdownTask.value?(openBlock(),createElementBlock("div",_hoisted_8," 即将执行："+toDisplayString(shortestCountdownTask.value.task.name)+" ("+toDisplayString(shortestCountdownTask.value.countdown.formatted)+") ",1)):(openBlock(),createElementBlock("div",_hoisted_9," 暂无定时任务 ")),createBaseVNode("div",_hoisted_10,[createVNode(t,{type:"primary",size:"small",onClick:openTaskModal},{default:withCtx(()=>[...e[82]||(e[82]=[createTextVNode(" 新增定时任务 ",-1)])]),_:1}),createVNode(t,{size:"small",onClick:e[0]||(e[0]=o=>showTasksModal.value=!0)},{default:withCtx(()=>[...e[83]||(e[83]=[createTextVNode(" 查看定时任务 ",-1)])]),_:1})])])]),createBaseVNode("div",_hoisted_11,[createVNode(t,{type:"primary",onClick:startBatch,disabled:isRunning.value||selectedTokens.value.length===0,size:"medium"},{default:withCtx(()=>[createTextVNode(toDisplayString(isRunning.value?"执行中...":"开始执行"),1)]),_:1},8,["disabled"]),createVNode(t,{onClick:stopBatch,disabled:!isRunning.value,type:"error",size:"medium"},{default:withCtx(()=>[...e[85]||(e[85]=[createTextVNode(" 停止 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{onClick:openTemplateManagerModal,type:"info",size:"medium"},{default:withCtx(()=>[...e[86]||(e[86]=[createTextVNode(" 任务模板 ",-1)])]),_:1}),createVNode(t,{onClick:openBatchSettings,type:"default",size:"medium"},{icon:withCtx(()=>[createVNode(s,null,{default:withCtx(()=>[createVNode(unref(Settings))]),_:1})]),default:withCtx(()=>[e[87]||(e[87]=createTextVNode(" 设置 ",-1))]),_:1})])]),createVNode(g,{title:"账号列表",class:"token-list-card"},{default:withCtx(()=>[createVNode(n,{style:{"margin-bottom":"12px"}},{default:withCtx(()=>[createVNode(t,{size:"small",onClick:claimHangUpRewards,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[88]||(e[88]=[createTextVNode(" 领取挂机 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchAddHangUpTime,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[89]||(e[89]=[createTextVNode(" 一键加钟 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:resetBottles,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[90]||(e[90]=[createTextVNode(" 重置罐子 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchlingguanzi,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[91]||(e[91]=[createTextVNode(" 一键领取罐子 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:climbTower,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[92]||(e[92]=[createTextVNode(" 一键爬塔 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:climbWeirdTower,disabled:isRunning.value||selectedTokens.value.length===0||!isWeirdTowerActivityOpen.value},{default:withCtx(()=>[...e[93]||(e[93]=[createTextVNode(" 一键爬怪异塔 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchStudy,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[94]||(e[94]=[createTextVNode(" 一键答题 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchSmartSendCar,disabled:isRunning.value||selectedTokens.value.length===0||!isCarActivityOpen.value},{default:withCtx(()=>[...e[95]||(e[95]=[createTextVNode(" 智能发车 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchClaimCars,disabled:isRunning.value||selectedTokens.value.length===0||!isCarActivityOpen.value},{default:withCtx(()=>[...e[96]||(e[96]=[createTextVNode(" 一键收车 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:e[1]||(e[1]=o=>openHelperModal("box")),disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[97]||(e[97]=[createTextVNode(" 批量开箱 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchClaimBoxPointReward,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[98]||(e[98]=[createTextVNode(" 领取宝箱积分 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:e[2]||(e[2]=o=>openHelperModal("fish")),disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[99]||(e[99]=[createTextVNode(" 批量钓鱼 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:e[3]||(e[3]=o=>openHelperModal("recruit")),disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[100]||(e[100]=[createTextVNode(" 批量招募 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchbaoku13,disabled:isRunning.value||selectedTokens.value.length===0||!isbaokuActivityOpen.value},{default:withCtx(()=>[...e[101]||(e[101]=[createTextVNode(" 一键宝库前3层 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchbaoku45,disabled:isRunning.value||selectedTokens.value.length===0||!isbaokuActivityOpen.value},{default:withCtx(()=>[...e[102]||(e[102]=[createTextVNode(" 一键宝库4,5层 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchmengjing,disabled:isRunning.value||selectedTokens.value.length===0||!ismengjingActivityOpen.value},{default:withCtx(()=>[...e[103]||(e[103]=[createTextVNode(" 一键梦境 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchclubsign,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[104]||(e[104]=[createTextVNode(" 一键俱乐部签到 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batcharenafight,disabled:isRunning.value||selectedTokens.value.length===0||!isarenaActivityOpen.value},{default:withCtx(()=>[...e[105]||(e[105]=[createTextVNode(" 一键竞技场战斗3次 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchTopUpFish,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[106]||(e[106]=[createTextVNode(" 一键钓鱼补齐 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchTopUpArena,disabled:isRunning.value||selectedTokens.value.length===0||!isarenaActivityOpen.value},{default:withCtx(()=>[...e[107]||(e[107]=[createTextVNode(" 一键竞技场补齐 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchClaimFreeEnergy,disabled:isRunning.value||selectedTokens.value.length===0||!isWeirdTowerActivityOpen.value},{default:withCtx(()=>[...e[108]||(e[108]=[createTextVNode(" 一键领取怪异塔免费道具 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:legion_storebuygoods,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[109]||(e[109]=[createTextVNode(" 一键购买四圣碎片 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:legionStoreBuySkinCoins,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[110]||(e[110]=[createTextVNode(" 一键购买俱乐部5皮肤币 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:store_purchase,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[111]||(e[111]=[createTextVNode(" 一键黑市采购 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:collection_claimfreereward,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[112]||(e[112]=[createTextVNode(" 免费领取珍宝阁 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:batchLegacyClaim,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[113]||(e[113]=[createTextVNode(" 批量功法残卷领取 ",-1)])]),_:1},8,["disabled"]),createVNode(t,{size:"small",onClick:e[4]||(e[4]=o=>showLegacyGiftModal.value=!0),disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[114]||(e[114]=[createTextVNode(" 批量功法残卷赠送 ",-1)])]),_:1},8,["disabled"])]),_:1}),createBaseVNode("div",_hoisted_12,[createVNode(n,{align:"center"},{default:withCtx(()=>[createVNode(i,{size:"small"},{default:withCtx(()=>[createVNode(t,{onClick:e[5]||(e[5]=o=>toggleSort("name")),type:sortConfig.value.field==="name"?"primary":"default"},{default:withCtx(()=>[createTextVNode(" 名称 "+toDisplayString(getSortIcon("name")),1)]),_:1},8,["type"]),createVNode(t,{onClick:e[6]||(e[6]=o=>toggleSort("server")),type:sortConfig.value.field==="server"?"primary":"default"},{default:withCtx(()=>[createTextVNode(" 服务器 "+toDisplayString(getSortIcon("server")),1)]),_:1},8,["type"]),createVNode(t,{onClick:e[7]||(e[7]=o=>toggleSort("createdAt")),type:sortConfig.value.field==="createdAt"?"primary":"default"},{default:withCtx(()=>[createTextVNode(" 创建时间 "+toDisplayString(getSortIcon("createdAt")),1)]),_:1},8,["type"]),createVNode(t,{onClick:e[8]||(e[8]=o=>toggleSort("lastUsed")),type:sortConfig.value.field==="lastUsed"?"primary":"default"},{default:withCtx(()=>[createTextVNode(" 最后使用 "+toDisplayString(getSortIcon("lastUsed")),1)]),_:1},8,["type"])]),_:1})]),_:1})]),createVNode(n,{vertical:""},{default:withCtx(()=>[createVNode(r,{checked:isAllSelected.value,indeterminate:isIndeterminate.value,"onUpdate:checked":handleSelectAll},{default:withCtx(()=>[...e[115]||(e[115]=[createTextVNode(" 全选 ",-1)])]),_:1},8,["checked","indeterminate"]),createVNode(v,{value:selectedTokens.value,"onUpdate:value":e[9]||(e[9]=o=>selectedTokens.value=o)},{default:withCtx(()=>[createVNode(u,{"x-gap":12,"y-gap":8,cols:batchSettings.tokenListColumns},{default:withCtx(()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(sortedTokens.value,o=>(openBlock(),createBlock(c,{key:o.id},{default:withCtx(()=>[createBaseVNode("div",_hoisted_13,[createVNode(r,{value:o.id,label:o.name,style:{flex:"1"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_14,[createBaseVNode("span",null,toDisplayString(o.name),1),createVNode(l,{size:"small",type:getStatusType(o.id),style:{"margin-left":"8px"}},{default:withCtx(()=>[createTextVNode(toDisplayString(getStatusText(o.id)),1)]),_:2},1032,["type"])])]),_:2},1032,["value","label"]),createVNode(t,{size:"tiny",circle:"",onClick:withModifiers(b=>openSettings(o),["stop"])},{icon:withCtx(()=>[createVNode(s,null,{default:withCtx(()=>[createVNode(unref(Settings))]),_:1})]),_:1},8,["onClick"])])]),_:2},1024))),128))]),_:1},8,["cols"])]),_:1},8,["value"])]),_:1})]),_:1}),batchSettings.hideScheduledTasksModule?createCommentVNode("",!0):(openBlock(),createBlock(g,{key:0,title:"定时任务",class:"scheduled-tasks-card",style:{"margin-top":"16px"}},{default:withCtx(()=>[createVNode(n,{style:{"margin-bottom":"12px"}},{default:withCtx(()=>[createVNode(t,{type:"primary",size:"small",onClick:openTaskModal},{default:withCtx(()=>[...e[116]||(e[116]=[createTextVNode(" 新增定时任务 ",-1)])]),_:1}),createVNode(t,{size:"small",onClick:e[10]||(e[10]=o=>showTasksModal.value=!0)},{default:withCtx(()=>[...e[117]||(e[117]=[createTextVNode(" 查看定时任务 ",-1)])]),_:1})]),_:1}),createBaseVNode("div",_hoisted_15,[e[118]||(e[118]=createBaseVNode("h4",{style:{margin:"0 0 12px 0",color:"#333"}},"即将执行的任务",-1)),shortestCountdownTask.value?(openBlock(),createElementBlock("div",_hoisted_16,[createBaseVNode("div",_hoisted_17,toDisplayString(shortestCountdownTask.value.task.name),1),createBaseVNode("div",{style:normalizeStyle([{"font-size":"24px","font-weight":"bold",color:"#1677ff"},{color:shortestCountdownTask.value.countdown.isNearExecution?"#ff4d4f":"#1677ff"}])},toDisplayString(shortestCountdownTask.value.countdown.formatted),5)])):(openBlock(),createElementBlock("div",_hoisted_18," 暂无定时任务 "))]),scheduledTasks.value.length>0?(openBlock(),createElementBlock("div",_hoisted_19,[createBaseVNode("p",null,"已保存 "+toDisplayString(scheduledTasks.value.length)+" 个定时任务",1)])):(openBlock(),createElementBlock("div",_hoisted_20,[...e[119]||(e[119]=[createBaseVNode("p",null,"暂无定时任务",-1)])]))]),_:1}))]),createBaseVNode("div",_hoisted_21,[createVNode(g,{class:"log-card"},{header:withCtx(()=>[createBaseVNode("div",_hoisted_22,[createBaseVNode("div",_hoisted_23,toDisplayString(currentRunningTokenName.value?`正在执行: ${currentRunningTokenName.value}`:"执行日志"),1),createBaseVNode("div",_hoisted_24,[createVNode(r,{checked:autoScrollLog.value,"onUpdate:checked":e[11]||(e[11]=o=>autoScrollLog.value=o),size:"small"},{default:withCtx(()=>[...e[120]||(e[120]=[createTextVNode(" 自动滚动 ",-1)])]),_:1},8,["checked"]),createVNode(r,{checked:filterErrorsOnly.value,"onUpdate:checked":e[12]||(e[12]=o=>filterErrorsOnly.value=o),size:"small"},{default:withCtx(()=>[...e[121]||(e[121]=[createTextVNode(" 只看错误 ",-1)])]),_:1},8,["checked"]),errorCount.value>0?(openBlock(),createBlock(l,{key:0,type:"error",size:"small"},{default:withCtx(()=>[createTextVNode(toDisplayString(errorCount.value)+" 个错误 ",1)]),_:1})):createCommentVNode("",!0),createVNode(t,{size:"small",onClick:copyLogs},{default:withCtx(()=>[...e[122]||(e[122]=[createTextVNode(" 复制日志 ",-1)])]),_:1})])])]),default:withCtx(()=>[createVNode(m,{type:"line",percentage:currentProgress.value,"indicator-placement":"inside",processing:""},null,8,["percentage"]),createBaseVNode("div",{class:"log-container",ref_key:"logContainer",ref:logContainer},[(openBlock(!0),createElementBlock(Fragment,null,renderList(filteredLogs.value,(o,b)=>(openBlock(),createElementBlock("div",{key:b,class:normalizeClass(["log-item",o.type])},[createBaseVNode("span",_hoisted_25,toDisplayString(o.time),1),createBaseVNode("span",_hoisted_26,toDisplayString(o.message),1)],2))),128))],512)]),_:1})])]),createVNode(y,{show:showSettingsModal.value,"onUpdate:show":e[23]||(e[23]=o=>showSettingsModal.value=o),preset:"card",title:`任务设置 - ${currentSettingsTokenName.value}`,style:{width:"90%","max-width":"400px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_27,[createBaseVNode("div",_hoisted_28,[createBaseVNode("div",_hoisted_29,[e[123]||(e[123]=createBaseVNode("label",{class:"setting-label"},"竞技场阵容",-1)),createVNode(d,{value:currentSettings.arenaFormation,"onUpdate:value":e[13]||(e[13]=o=>currentSettings.arenaFormation=o),options:unref(formationOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_30,[e[124]||(e[124]=createBaseVNode("label",{class:"setting-label"},"BOSS阵容",-1)),createVNode(d,{value:currentSettings.bossFormation,"onUpdate:value":e[14]||(e[14]=o=>currentSettings.bossFormation=o),options:unref(formationOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_31,[e[125]||(e[125]=createBaseVNode("label",{class:"setting-label"},"BOSS次数",-1)),createVNode(d,{value:currentSettings.bossTimes,"onUpdate:value":e[15]||(e[15]=o=>currentSettings.bossTimes=o),options:unref(bossTimesOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_32,[createBaseVNode("div",_hoisted_33,[e[126]||(e[126]=createBaseVNode("span",{class:"switch-label"},"领罐子",-1)),createVNode(p,{value:currentSettings.claimBottle,"onUpdate:value":e[16]||(e[16]=o=>currentSettings.claimBottle=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_34,[e[127]||(e[127]=createBaseVNode("span",{class:"switch-label"},"领挂机",-1)),createVNode(p,{value:currentSettings.claimHangUp,"onUpdate:value":e[17]||(e[17]=o=>currentSettings.claimHangUp=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_35,[e[128]||(e[128]=createBaseVNode("span",{class:"switch-label"},"竞技场",-1)),createVNode(p,{value:currentSettings.arenaEnable,"onUpdate:value":e[18]||(e[18]=o=>currentSettings.arenaEnable=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_36,[e[129]||(e[129]=createBaseVNode("span",{class:"switch-label"},"开宝箱",-1)),createVNode(p,{value:currentSettings.openBox,"onUpdate:value":e[19]||(e[19]=o=>currentSettings.openBox=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_37,[e[130]||(e[130]=createBaseVNode("span",{class:"switch-label"},"领取邮件奖励",-1)),createVNode(p,{value:currentSettings.claimEmail,"onUpdate:value":e[20]||(e[20]=o=>currentSettings.claimEmail=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_38,[e[131]||(e[131]=createBaseVNode("span",{class:"switch-label"},"黑市购买物品",-1)),createVNode(p,{value:currentSettings.blackMarketPurchase,"onUpdate:value":e[21]||(e[21]=o=>currentSettings.blackMarketPurchase=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_39,[e[132]||(e[132]=createBaseVNode("span",{class:"switch-label"},"付费招募",-1)),createVNode(p,{value:currentSettings.payRecruit,"onUpdate:value":e[22]||(e[22]=o=>currentSettings.payRecruit=o)},null,8,["value"])])])]),createBaseVNode("div",_hoisted_40,[createVNode(t,{type:"primary",onClick:saveSettings},{default:withCtx(()=>[...e[133]||(e[133]=[createTextVNode("保存设置",-1)])]),_:1})])])]),_:1},8,["show","title"]),createVNode(y,{show:showTaskTemplateModal.value,"onUpdate:show":e[36]||(e[36]=o=>showTaskTemplateModal.value=o),preset:"card",title:currentTemplateId.value?"编辑任务模板":"任务模板设置",style:{width:"90%","max-width":"400px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_41,[createBaseVNode("div",_hoisted_42,[createBaseVNode("div",_hoisted_43,[e[134]||(e[134]=createBaseVNode("label",{class:"setting-label"},"模板名称",-1)),createVNode(f,{value:currentTemplateName.value,"onUpdate:value":e[24]||(e[24]=o=>currentTemplateName.value=o),placeholder:"请输入模板名称",size:"small"},null,8,["value"])]),createBaseVNode("div",_hoisted_44,[e[135]||(e[135]=createBaseVNode("label",{class:"setting-label"},"竞技场阵容",-1)),createVNode(d,{value:currentTemplate.arenaFormation,"onUpdate:value":e[25]||(e[25]=o=>currentTemplate.arenaFormation=o),options:unref(formationOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_45,[e[136]||(e[136]=createBaseVNode("label",{class:"setting-label"},"BOSS阵容",-1)),createVNode(d,{value:currentTemplate.bossFormation,"onUpdate:value":e[26]||(e[26]=o=>currentTemplate.bossFormation=o),options:unref(formationOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_46,[e[137]||(e[137]=createBaseVNode("label",{class:"setting-label"},"BOSS次数",-1)),createVNode(d,{value:currentTemplate.bossTimes,"onUpdate:value":e[27]||(e[27]=o=>currentTemplate.bossTimes=o),options:unref(bossTimesOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_47,[createBaseVNode("div",_hoisted_48,[e[138]||(e[138]=createBaseVNode("span",{class:"switch-label"},"领罐子",-1)),createVNode(p,{value:currentTemplate.claimBottle,"onUpdate:value":e[28]||(e[28]=o=>currentTemplate.claimBottle=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_49,[e[139]||(e[139]=createBaseVNode("span",{class:"switch-label"},"领挂机",-1)),createVNode(p,{value:currentTemplate.claimHangUp,"onUpdate:value":e[29]||(e[29]=o=>currentTemplate.claimHangUp=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_50,[e[140]||(e[140]=createBaseVNode("span",{class:"switch-label"},"竞技场",-1)),createVNode(p,{value:currentTemplate.arenaEnable,"onUpdate:value":e[30]||(e[30]=o=>currentTemplate.arenaEnable=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_51,[e[141]||(e[141]=createBaseVNode("span",{class:"switch-label"},"开宝箱",-1)),createVNode(p,{value:currentTemplate.openBox,"onUpdate:value":e[31]||(e[31]=o=>currentTemplate.openBox=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_52,[e[142]||(e[142]=createBaseVNode("span",{class:"switch-label"},"领取邮件奖励",-1)),createVNode(p,{value:currentTemplate.claimEmail,"onUpdate:value":e[32]||(e[32]=o=>currentTemplate.claimEmail=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_53,[e[143]||(e[143]=createBaseVNode("span",{class:"switch-label"},"黑市购买物品",-1)),createVNode(p,{value:currentTemplate.blackMarketPurchase,"onUpdate:value":e[33]||(e[33]=o=>currentTemplate.blackMarketPurchase=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_54,[e[144]||(e[144]=createBaseVNode("span",{class:"switch-label"},"付费招募",-1)),createVNode(p,{value:currentTemplate.payRecruit,"onUpdate:value":e[34]||(e[34]=o=>currentTemplate.payRecruit=o)},null,8,["value"])])])]),createBaseVNode("div",_hoisted_55,[createVNode(t,{onClick:e[35]||(e[35]=o=>showTaskTemplateModal.value=!1),style:{"margin-right":"12px"}},{default:withCtx(()=>[...e[145]||(e[145]=[createTextVNode("取消",-1)])]),_:1}),createVNode(t,{onClick:saveTaskTemplate,type:"primary"},{default:withCtx(()=>[...e[146]||(e[146]=[createTextVNode("保存模板",-1)])]),_:1})])])]),_:1},8,["show","title"]),createVNode(y,{show:showApplyTemplateModal.value,"onUpdate:show":e[40]||(e[40]=o=>showApplyTemplateModal.value=o),preset:"card",title:"应用任务模板",style:{width:"90%","max-width":"600px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_56,[createBaseVNode("div",_hoisted_57,[createBaseVNode("div",_hoisted_58,[e[147]||(e[147]=createBaseVNode("label",{class:"setting-label"},"选择模板",-1)),createVNode(d,{value:selectedTemplateId.value,"onUpdate:value":e[37]||(e[37]=o=>selectedTemplateId.value=o),options:taskTemplates.value,"label-field":"name","value-field":"id",placeholder:"请选择要应用的模板",size:"small",style:{width:"100%"}},null,8,["value","options"])]),createBaseVNode("div",_hoisted_59,[e[149]||(e[149]=createBaseVNode("label",{class:"setting-label"},"选择账号",-1)),createVNode(r,{checked:isAllSelectedForApply.value,indeterminate:isIndeterminateForApply.value,"onUpdate:checked":handleSelectAllForApply},{default:withCtx(()=>[...e[148]||(e[148]=[createTextVNode(" 全选 ",-1)])]),_:1},8,["checked","indeterminate"]),createVNode(v,{value:selectedTokensForApply.value,"onUpdate:value":e[38]||(e[38]=o=>selectedTokensForApply.value=o),style:{"margin-top":"8px"}},{default:withCtx(()=>[createVNode(u,{cols:2,"x-gap":12,"y-gap":8},{default:withCtx(()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(sortedTokens.value,o=>(openBlock(),createBlock(c,{key:o.id},{default:withCtx(()=>[createVNode(r,{value:o.id},{default:withCtx(()=>[createTextVNode(toDisplayString(o.name),1)]),_:2},1032,["value"])]),_:2},1024))),128))]),_:1})]),_:1},8,["value"])])]),createBaseVNode("div",_hoisted_60,[createVNode(t,{onClick:e[39]||(e[39]=o=>showApplyTemplateModal.value=!1)},{default:withCtx(()=>[...e[150]||(e[150]=[createTextVNode("取消",-1)])]),_:1}),createVNode(t,{onClick:applyTemplate,type:"success",disabled:!selectedTemplateId.value||selectedTokensForApply.value.length===0},{default:withCtx(()=>[...e[151]||(e[151]=[createTextVNode("应用模板",-1)])]),_:1},8,["disabled"])])])]),_:1},8,["show"]),createVNode(y,{show:showTemplateManagerModal.value,"onUpdate:show":e[42]||(e[42]=o=>showTemplateManagerModal.value=o),preset:"card",title:"任务模板管理",style:{width:"90%","max-width":"800px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_61,[createBaseVNode("div",_hoisted_62,[createBaseVNode("div",null,[createVNode(t,{type:"primary",onClick:openNewTemplateModal},{default:withCtx(()=>[...e[152]||(e[152]=[createTextVNode("新增模板",-1)])]),_:1}),createVNode(t,{onClick:openApplyTemplateModal,type:"success",style:{"margin-left":"8px"}},{default:withCtx(()=>[...e[153]||(e[153]=[createTextVNode("应用模板",-1)])]),_:1}),createVNode(t,{onClick:openAccountTemplateModal,type:"info",style:{"margin-left":"8px"}},{default:withCtx(()=>[...e[154]||(e[154]=[createTextVNode("查看账号模板引用",-1)])]),_:1})]),createVNode(f,{placeholder:"搜索模板",size:"small",style:{width:"200px"}})]),createBaseVNode("div",_hoisted_63,[(openBlock(!0),createElementBlock(Fragment,null,renderList(filteredTaskTemplates.value,o=>(openBlock(),createBlock(g,{key:o.id,size:"small",style:{"margin-bottom":"12px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_64,[createBaseVNode("div",null,[createBaseVNode("h4",_hoisted_65,toDisplayString(o.name),1),createBaseVNode("div",_hoisted_66,[createTextVNode(" 创建时间: "+toDisplayString(new Date(o.createdAt).toLocaleString())+" ",1),o.updatedAt?(openBlock(),createElementBlock("span",_hoisted_67,", 更新时间: "+toDisplayString(new Date(o.updatedAt).toLocaleString()),1)):createCommentVNode("",!0)])]),createBaseVNode("div",_hoisted_68,[createVNode(t,{size:"small",onClick:b=>openEditTemplateModal(o)},{default:withCtx(()=>[...e[155]||(e[155]=[createTextVNode("编辑",-1)])]),_:1},8,["onClick"]),createVNode(t,{size:"small",type:"error",onClick:b=>deleteTaskTemplate(o.id)},{default:withCtx(()=>[...e[156]||(e[156]=[createTextVNode("删除",-1)])]),_:1},8,["onClick"])])])]),_:2},1024))),128)),filteredTaskTemplates.value.length===0?(openBlock(),createElementBlock("div",_hoisted_69," 暂无模板 ")):createCommentVNode("",!0)]),createBaseVNode("div",_hoisted_70,[createVNode(t,{onClick:e[41]||(e[41]=o=>showTemplateManagerModal.value=!1)},{default:withCtx(()=>[...e[157]||(e[157]=[createTextVNode("关闭",-1)])]),_:1})])])]),_:1},8,["show"]),createVNode(y,{show:showAccountTemplateModal.value,"onUpdate:show":e[45]||(e[45]=o=>showAccountTemplateModal.value=o),preset:"card",title:"账号模板引用查看",style:{width:"90%","max-width":"800px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_71,[createBaseVNode("div",_hoisted_72,[createBaseVNode("div",null,[createBaseVNode("span",null,"共 "+toDisplayString(filteredAccountTemplates.value.length)+" 个账号",1)]),createBaseVNode("div",_hoisted_73,[e[158]||(e[158]=createBaseVNode("label",{style:{"font-size":"12px",color:"#86909c"}},"按模板筛选:",-1)),createVNode(d,{value:selectedTemplateForFilter.value,"onUpdate:value":[e[43]||(e[43]=o=>selectedTemplateForFilter.value=o),filterAccountTemplates],options:taskTemplates.value,"label-field":"name","value-field":"id",placeholder:"全部模板",size:"small",style:{width:"180px"}},null,8,["value","options"])])]),createBaseVNode("div",_hoisted_74,[(openBlock(!0),createElementBlock(Fragment,null,renderList(filteredAccountTemplates.value,o=>(openBlock(),createBlock(g,{key:o.tokenId,size:"small",style:{"margin-bottom":"12px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_75,[createBaseVNode("div",null,[createBaseVNode("h4",_hoisted_76,toDisplayString(o.tokenName),1)]),createBaseVNode("div",null,[createVNode(l,{type:o.templateId?"success":"default",size:"small"},{default:withCtx(()=>[createTextVNode(toDisplayString(o.templateName),1)]),_:2},1032,["type"])])])]),_:2},1024))),128)),filteredAccountTemplates.value.length===0?(openBlock(),createElementBlock("div",_hoisted_77," 暂无账号数据 ")):createCommentVNode("",!0)]),createBaseVNode("div",_hoisted_78,[createVNode(t,{onClick:e[44]||(e[44]=o=>showAccountTemplateModal.value=!1)},{default:withCtx(()=>[...e[159]||(e[159]=[createTextVNode("关闭",-1)])]),_:1})])])]),_:1},8,["show"]),createVNode(y,{show:showLegacyGiftModal.value,"onUpdate:show":e[50]||(e[50]=o=>showLegacyGiftModal.value=o),preset:"card",title:"批量功法残卷赠送",style:{width:"90%","max-width":"600px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_79,[createBaseVNode("div",_hoisted_80,[createBaseVNode("div",_hoisted_81,[e[161]||(e[161]=createBaseVNode("label",{class:"setting-label"},"接收者ID",-1)),createVNode(n,null,{default:withCtx(()=>[createVNode(f,{value:recipientIdInput.value,"onUpdate:value":e[46]||(e[46]=o=>recipientIdInput.value=o),placeholder:"请输入接收者ID",type:"number",onInput:clearRecipientError,style:{width:"180px"}},null,8,["value"]),createVNode(f,{value:securityPassword.value,"onUpdate:value":e[47]||(e[47]=o=>securityPassword.value=o),placeholder:"请输入安全密码",type:"password",onInput:clearRecipientError,style:{width:"180px"}},null,8,["value"]),createVNode(t,{type:"primary",onClick:queryRecipientInfo,disabled:!recipientIdInput.value||isQueryingRecipient.value||!securityPassword.value},{default:withCtx(()=>[...e[160]||(e[160]=[createTextVNode(" 查询 ",-1)])]),_:1},8,["disabled"])]),_:1}),recipientIdError.value?(openBlock(),createBlock(w,{key:0,type:"error",style:{"margin-top":"5px",display:"block"}},{default:withCtx(()=>[createTextVNode(toDisplayString(recipientIdError.value),1)]),_:1})):createCommentVNode("",!0)]),recipientInfo.value?(openBlock(),createElementBlock("div",_hoisted_82,[e[168]||(e[168]=createBaseVNode("label",{class:"setting-label"},"接收者信息",-1)),createBaseVNode("div",_hoisted_83,[createBaseVNode("div",_hoisted_84,[recipientInfo.value.avatarUrl&&!avatarLoadError.value?(openBlock(),createElementBlock("img",{key:0,src:recipientInfo.value.avatarUrl,alt:"角色头像",style:{width:"100%",height:"100%","object-fit":"cover",transition:"all 0.3s ease"},onError:handleAvatarError,onLoad:handleAvatarLoad},null,40,_hoisted_85)):(openBlock(),createElementBlock("div",_hoisted_86,toDisplayString((recipientInfo.value.name||"未知角色")[0]||"?"),1)),isAvatarLoading.value?(openBlock(),createElementBlock("div",_hoisted_87,[...e[162]||(e[162]=[createBaseVNode("div",{class:"loading-spinner",style:{width:"30px",height:"30px",border:"3px solid rgba(255, 255, 255, 0.3)","border-top":"3px solid white","border-radius":"50%",animation:"spin 1s linear infinite"}},null,-1)])])):createCommentVNode("",!0)]),createBaseVNode("div",_hoisted_88,[createBaseVNode("div",_hoisted_89,toDisplayString(recipientInfo.value.name||"未知角色"),1),createBaseVNode("div",_hoisted_90,[createBaseVNode("div",_hoisted_91,[e[163]||(e[163]=createBaseVNode("div",{class:"info-label",style:{"font-size":"12px",color:"#86909c","margin-bottom":"2px"}}," 角色ID ",-1)),createBaseVNode("div",_hoisted_92,toDisplayString(recipientInfo.value.roleId),1)]),createBaseVNode("div",_hoisted_93,[e[164]||(e[164]=createBaseVNode("div",{class:"info-label",style:{"font-size":"12px",color:"#86909c","margin-bottom":"2px"}}," 服务器 ",-1)),createBaseVNode("div",_hoisted_94,toDisplayString(recipientInfo.value.serverName),1)]),createBaseVNode("div",_hoisted_95,[e[165]||(e[165]=createBaseVNode("div",{class:"info-label",style:{"font-size":"12px",color:"#86909c","margin-bottom":"2px"}}," 战力 ",-1)),createBaseVNode("div",_hoisted_96,toDisplayString(recipientInfo.value.power)+" "+toDisplayString(recipientInfo.value.powerUnit),1)]),createBaseVNode("div",_hoisted_97,[e[166]||(e[166]=createBaseVNode("div",{class:"info-label",style:{"font-size":"12px",color:"#86909c","margin-bottom":"2px"}}," 军团 ",-1)),createBaseVNode("div",_hoisted_98,toDisplayString(recipientInfo.value.legionName||"无"),1)]),createBaseVNode("div",_hoisted_99,[e[167]||(e[167]=createBaseVNode("div",{class:"info-label",style:{"font-size":"12px",color:"#86909c","margin-bottom":"2px"}}," 军团ID ",-1)),createBaseVNode("div",_hoisted_100,toDisplayString(recipientInfo.value.legionId||"无"),1)])])])])])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_101,[e[169]||(e[169]=createBaseVNode("label",{class:"setting-label"},"赠送数量",-1)),createVNode(h,{value:giftQuantity.value,"onUpdate:value":e[48]||(e[48]=o=>giftQuantity.value=o),min:1,max:1e3,step:1,placeholder:"请输入赠送数量"},null,8,["value"])])]),createBaseVNode("div",_hoisted_102,[createVNode(t,{onClick:e[49]||(e[49]=o=>showLegacyGiftModal.value=!1),style:{"margin-right":"12px"}},{default:withCtx(()=>[...e[170]||(e[170]=[createTextVNode("取消",-1)])]),_:1}),createVNode(t,{type:"primary",onClick:confirmLegacyGift,disabled:!recipientIdInput.value||!recipientInfo.value},{default:withCtx(()=>[...e[171]||(e[171]=[createTextVNode(" 开始赠送 ",-1)])]),_:1},8,["disabled"])])])]),_:1},8,["show"]),createVNode(y,{show:showHelperModal.value,"onUpdate:show":e[55]||(e[55]=o=>showHelperModal.value=o),preset:"card",title:helperModalTitle.value,style:{width:"90%","max-width":"400px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_103,[createBaseVNode("div",_hoisted_104,[helperType.value==="box"?(openBlock(),createElementBlock("div",_hoisted_105,[e[172]||(e[172]=createBaseVNode("label",{class:"setting-label"},"宝箱类型",-1)),createVNode(d,{value:helperSettings.boxType,"onUpdate:value":e[51]||(e[51]=o=>helperSettings.boxType=o),options:boxTypeOptions,size:"small"},null,8,["value"])])):createCommentVNode("",!0),helperType.value==="fish"?(openBlock(),createElementBlock("div",_hoisted_106,[e[173]||(e[173]=createBaseVNode("label",{class:"setting-label"},"鱼竿类型",-1)),createVNode(d,{value:helperSettings.fishType,"onUpdate:value":e[52]||(e[52]=o=>helperSettings.fishType=o),options:fishTypeOptions,size:"small"},null,8,["value"])])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_107,[e[174]||(e[174]=createBaseVNode("label",{class:"setting-label"},"消耗数量（10的倍数）",-1)),createVNode(h,{value:helperSettings.count,"onUpdate:value":e[53]||(e[53]=o=>helperSettings.count=o),min:10,max:1e4,step:10,size:"small"},null,8,["value"])])]),createBaseVNode("div",_hoisted_108,[createVNode(t,{onClick:e[54]||(e[54]=o=>showHelperModal.value=!1),style:{"margin-right":"12px"}},{default:withCtx(()=>[...e[175]||(e[175]=[createTextVNode("取消",-1)])]),_:1}),createVNode(t,{type:"primary",onClick:executeHelper},{default:withCtx(()=>[...e[176]||(e[176]=[createTextVNode("开始执行",-1)])]),_:1})])])]),_:1},8,["show","title"]),createVNode(y,{show:showTasksModal.value,"onUpdate:show":e[56]||(e[56]=o=>showTasksModal.value=o),preset:"card",title:"定时任务列表",style:{width:"90%","max-width":"800px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_109,[(openBlock(!0),createElementBlock(Fragment,null,renderList(scheduledTasks.value,o=>{var b,N;return openBlock(),createElementBlock("div",{key:o.id,class:"task-item",style:{"margin-bottom":"16px",padding:"12px",border:"1px solid #e5e7eb","border-radius":"8px"}},[createBaseVNode("div",_hoisted_110,[createBaseVNode("div",_hoisted_111,toDisplayString(o.name),1),createVNode(p,{value:o.enabled,"onUpdate:value":[x=>o.enabled=x,x=>toggleTaskEnabled(o.id,x)]},null,8,["value","onUpdate:value"])]),createBaseVNode("div",_hoisted_112,[e[177]||(e[177]=createBaseVNode("span",{style:{color:"#6b7280"}},"运行类型：",-1)),createBaseVNode("span",null,toDisplayString(o.runType==="daily"?"每天固定时间":"Cron表达式"),1)]),createBaseVNode("div",_hoisted_113,[e[178]||(e[178]=createBaseVNode("span",{style:{color:"#6b7280"}},"运行时间：",-1)),createBaseVNode("span",null,toDisplayString(o.runType==="daily"?o.runTime:o.cronExpression),1)]),createBaseVNode("div",_hoisted_114,[e[179]||(e[179]=createBaseVNode("span",{style:{color:"#6b7280"}},"下次执行：",-1)),createBaseVNode("span",{style:normalizeStyle({fontWeight:"bold",color:(b=taskCountdowns.value[o.id])!=null&&b.isNearExecution?"#ff4d4f":"#1677ff"})},toDisplayString(((N=taskCountdowns.value[o.id])==null?void 0:N.formatted)||"计算中..."),5)]),createBaseVNode("div",_hoisted_115,[e[180]||(e[180]=createBaseVNode("span",{style:{color:"#6b7280"}},"选中账号：",-1)),createBaseVNode("span",null,toDisplayString(o.selectedTokens.length)+" 个",1)]),createBaseVNode("div",_hoisted_116,[e[181]||(e[181]=createBaseVNode("span",{style:{color:"#6b7280"}},"选中任务：",-1)),createBaseVNode("span",null,toDisplayString(o.selectedTasks.length)+" 个",1)]),createBaseVNode("div",_hoisted_117,[createVNode(t,{size:"tiny",onClick:x=>editTask(o)},{default:withCtx(()=>[...e[182]||(e[182]=[createTextVNode(" 编辑 ",-1)])]),_:1},8,["onClick"]),createVNode(t,{size:"tiny",type:"error",onClick:x=>deleteTask(o.id)},{default:withCtx(()=>[...e[183]||(e[183]=[createTextVNode(" 删除 ",-1)])]),_:1},8,["onClick"])])])}),128)),scheduledTasks.value.length===0?(openBlock(),createElementBlock("div",_hoisted_118," 暂无定时任务 ")):createCommentVNode("",!0)])]),_:1},8,["show"]),createVNode(y,{show:showTaskModal.value,"onUpdate:show":e[64]||(e[64]=o=>showTaskModal.value=o),preset:"card",title:editingTask.value?"编辑定时任务":"新增定时任务",style:{width:"90%","max-width":"600px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_119,[createBaseVNode("div",_hoisted_120,[createBaseVNode("div",_hoisted_121,[e[184]||(e[184]=createBaseVNode("label",{class:"setting-label"},"任务名称",-1)),createVNode(f,{value:taskForm.name,"onUpdate:value":e[57]||(e[57]=o=>taskForm.name=o),placeholder:"请输入任务名称"},null,8,["value"])]),createBaseVNode("div",_hoisted_122,[e[187]||(e[187]=createBaseVNode("label",{class:"setting-label"},"运行类型",-1)),createVNode(L,{value:taskForm.runType,"onUpdate:value":[e[58]||(e[58]=o=>taskForm.runType=o),resetRunType]},{default:withCtx(()=>[createVNode(S,{value:"daily"},{default:withCtx(()=>[...e[185]||(e[185]=[createTextVNode("每天固定时间",-1)])]),_:1}),createVNode(S,{value:"cron"},{default:withCtx(()=>[...e[186]||(e[186]=[createTextVNode("Cron表达式",-1)])]),_:1})]),_:1},8,["value"])]),taskForm.runType==="daily"?(openBlock(),createElementBlock("div",_hoisted_123,[e[188]||(e[188]=createBaseVNode("label",{class:"setting-label"},"运行时间",-1)),createVNode(k,{value:taskForm.runTime,"onUpdate:value":e[59]||(e[59]=o=>taskForm.runTime=o),format:"HH:mm"},null,8,["value"])])):createCommentVNode("",!0),taskForm.runType==="cron"?(openBlock(),createElementBlock("div",_hoisted_124,[e[190]||(e[190]=createBaseVNode("label",{class:"setting-label"},"Cron表达式",-1)),createVNode(f,{value:taskForm.cronExpression,"onUpdate:value":e[60]||(e[60]=o=>taskForm.cronExpression=o),placeholder:"请输入Cron表达式",onInput:parseCronExpression},null,8,["value"]),taskForm.cronExpression?(openBlock(),createElementBlock("div",_hoisted_125,[cronValidation.value.valid?(openBlock(),createElementBlock("div",_hoisted_126,[createVNode(w,{type:"success"},{default:withCtx(()=>[createTextVNode("✓ "+toDisplayString(cronValidation.value.message),1)]),_:1})])):(openBlock(),createElementBlock("div",_hoisted_127,[createVNode(w,{type:"error"},{default:withCtx(()=>[createTextVNode("✗ "+toDisplayString(cronValidation.value.message),1)]),_:1})])),cronValidation.value.valid&&cronNextRuns.value.length>0?(openBlock(),createElementBlock("div",_hoisted_128,[e[189]||(e[189]=createBaseVNode("h4",null,"未来5次执行时间：",-1)),createBaseVNode("ul",null,[(openBlock(!0),createElementBlock(Fragment,null,renderList(cronNextRuns.value,(o,b)=>(openBlock(),createElementBlock("li",{key:b},toDisplayString(o),1))),128))])])):createCommentVNode("",!0)])):createCommentVNode("",!0)])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_129,[createBaseVNode("div",_hoisted_130,[e[193]||(e[193]=createBaseVNode("label",{class:"setting-label"},"选择账号",-1)),createVNode(n,{size:"small"},{default:withCtx(()=>[createVNode(t,{size:"small",onClick:selectAllTokens},{default:withCtx(()=>[...e[191]||(e[191]=[createTextVNode(" 全选 ",-1)])]),_:1}),createVNode(t,{size:"small",onClick:deselectAllTokens},{default:withCtx(()=>[...e[192]||(e[192]=[createTextVNode(" 全不选 ",-1)])]),_:1})]),_:1})]),createVNode(v,{value:taskForm.selectedTokens,"onUpdate:value":e[61]||(e[61]=o=>taskForm.selectedTokens=o)},{default:withCtx(()=>[createVNode(u,{cols:2,"x-gap":12,"y-gap":8},{default:withCtx(()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(sortedTokens.value,o=>(openBlock(),createBlock(c,{key:o.id},{default:withCtx(()=>[createVNode(r,{value:o.id},{default:withCtx(()=>[createTextVNode(toDisplayString(o.name),1)]),_:2},1032,["value"])]),_:2},1024))),128))]),_:1})]),_:1},8,["value"])]),createBaseVNode("div",_hoisted_131,[createBaseVNode("div",_hoisted_132,[e[196]||(e[196]=createBaseVNode("label",{class:"setting-label"},"选择任务",-1)),createVNode(n,{size:"small"},{default:withCtx(()=>[createVNode(t,{size:"small",onClick:selectAllTasks},{default:withCtx(()=>[...e[194]||(e[194]=[createTextVNode(" 全选 ",-1)])]),_:1}),createVNode(t,{size:"small",onClick:deselectAllTasks},{default:withCtx(()=>[...e[195]||(e[195]=[createTextVNode(" 全不选 ",-1)])]),_:1})]),_:1})]),createVNode(v,{value:taskForm.selectedTasks,"onUpdate:value":e[62]||(e[62]=o=>taskForm.selectedTasks=o)},{default:withCtx(()=>[createVNode(u,{cols:2,"x-gap":12,"y-gap":8},{default:withCtx(()=>[(openBlock(),createElementBlock(Fragment,null,renderList(availableTasks,o=>createVNode(c,{key:o.value},{default:withCtx(()=>[createVNode(r,{value:o.value},{default:withCtx(()=>[createTextVNode(toDisplayString(o.label),1)]),_:2},1032,["value"])]),_:2},1024)),64))]),_:1})]),_:1},8,["value"])])]),createBaseVNode("div",_hoisted_133,[createVNode(t,{onClick:e[63]||(e[63]=o=>showTaskModal.value=!1),style:{"margin-right":"12px"}},{default:withCtx(()=>[...e[197]||(e[197]=[createTextVNode("取消",-1)])]),_:1}),createVNode(t,{type:"primary",onClick:saveTask},{default:withCtx(()=>[...e[198]||(e[198]=[createTextVNode("保存",-1)])]),_:1})])])]),_:1},8,["show","title"]),createVNode(y,{show:showBatchSettingsModal.value,"onUpdate:show":e[81]||(e[81]=o=>showBatchSettingsModal.value=o),preset:"card",title:"任务设置",style:{width:"90%","max-width":"400px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_134,[createVNode(T,{"title-placement":"left",style:{margin:"1px 0"}},{default:withCtx(()=>[...e[199]||(e[199]=[createTextVNode("定时批量操作设置",-1)])]),_:1}),createBaseVNode("div",_hoisted_135,[createBaseVNode("div",_hoisted_136,[e[200]||(e[200]=createBaseVNode("label",{class:"setting-label"},"定时批量开箱数量（10的倍数）",-1)),createVNode(h,{value:batchSettings.boxCount,"onUpdate:value":e[65]||(e[65]=o=>batchSettings.boxCount=o),min:10,max:1e4,step:10,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_137,[e[201]||(e[201]=createBaseVNode("label",{class:"setting-label"},"定时批量钓鱼数量（10的倍数）",-1)),createVNode(h,{value:batchSettings.fishCount,"onUpdate:value":e[66]||(e[66]=o=>batchSettings.fishCount=o),min:10,max:1e4,step:10,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_138,[e[202]||(e[202]=createBaseVNode("label",{class:"setting-label"},"定时批量招募数量（10的倍数）",-1)),createVNode(h,{value:batchSettings.recruitCount,"onUpdate:value":e[67]||(e[67]=o=>batchSettings.recruitCount=o),min:10,max:1e4,step:10,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_139,[e[203]||(e[203]=createBaseVNode("label",{class:"setting-label"},"默认宝箱类型",-1)),createVNode(d,{value:batchSettings.defaultBoxType,"onUpdate:value":e[68]||(e[68]=o=>batchSettings.defaultBoxType=o),options:boxTypeOptions,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_140,[e[204]||(e[204]=createBaseVNode("label",{class:"setting-label"},"默认鱼竿类型",-1)),createVNode(d,{value:batchSettings.defaultFishType,"onUpdate:value":e[69]||(e[69]=o=>batchSettings.defaultFishType=o),options:fishTypeOptions,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_141,[e[205]||(e[205]=createBaseVNode("label",{class:"setting-label"},"保底车辆颜色等级",-1)),createVNode(d,{value:batchSettings.carMinColor,"onUpdate:value":e[70]||(e[70]=o=>batchSettings.carMinColor=o),options:[{label:"绿·普通",value:1},{label:"蓝·稀有",value:2},{label:"紫·史诗",value:3},{label:"橙·传说",value:4},{label:"红·神话",value:5},{label:"金·传奇",value:6}],size:"small",style:{width:"140px"}},null,8,["value"])]),createVNode(T,{"title-placement":"left",style:{margin:"1px 0"}},{default:withCtx(()=>[...e[206]||(e[206]=[createTextVNode("功法定时赠送设置",-1)])]),_:1}),createBaseVNode("div",_hoisted_142,[e[207]||(e[207]=createBaseVNode("label",{class:"setting-label"},"接收者ID",-1)),createVNode(f,{value:batchSettings.receiverId,"onUpdate:value":e[71]||(e[71]=o=>batchSettings.receiverId=o),type:"text",placeholder:"请输入接收者ID",size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_143,[e[208]||(e[208]=createBaseVNode("label",{class:"setting-label"},"密码设置",-1)),createVNode(f,{value:batchSettings.password,"onUpdate:value":e[72]||(e[72]=o=>batchSettings.password=o),type:"password",placeholder:"请输入密码",size:"small",style:{width:"140px"}},null,8,["value"])]),createVNode(T,{"title-placement":"left",style:{margin:"1px 0"}},{default:withCtx(()=>[...e[209]||(e[209]=[createTextVNode("定时任务设置",-1)])]),_:1}),createBaseVNode("div",_hoisted_144,[e[210]||(e[210]=createBaseVNode("label",{class:"setting-label"},"隐藏底部定时任务模块",-1)),createVNode(p,{value:batchSettings.hideScheduledTasksModule,"onUpdate:value":e[73]||(e[73]=o=>batchSettings.hideScheduledTasksModule=o)},null,8,["value"])]),createBaseVNode("div",_hoisted_145,[e[211]||(e[211]=createBaseVNode("label",{class:"setting-label"},"账号列表每行显示数量",-1)),createVNode(h,{value:batchSettings.tokenListColumns,"onUpdate:value":e[74]||(e[74]=o=>batchSettings.tokenListColumns=o),min:1,max:10,step:1,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_146,[e[212]||(e[212]=createBaseVNode("label",{class:"setting-label"},"日常任务命令执行后延迟(ms)",-1)),createVNode(h,{value:batchSettings.commandDelay,"onUpdate:value":e[75]||(e[75]=o=>batchSettings.commandDelay=o),min:100,max:2e3,step:100,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_147,[e[213]||(e[213]=createBaseVNode("label",{class:"setting-label"},"日常任务任务间延迟(ms)",-1)),createVNode(h,{value:batchSettings.taskDelay,"onUpdate:value":e[76]||(e[76]=o=>batchSettings.taskDelay=o),min:100,max:2e3,step:100,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_148,[e[214]||(e[214]=createBaseVNode("label",{class:"setting-label"},"最大并发连接数",-1)),createVNode(h,{value:batchSettings.maxActive,"onUpdate:value":e[77]||(e[77]=o=>batchSettings.maxActive=o),min:1,max:20,step:1,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_149,[e[215]||(e[215]=createBaseVNode("label",{class:"setting-label"},"连接超时时间(ms)",-1)),createVNode(h,{value:batchSettings.connectionTimeout,"onUpdate:value":e[78]||(e[78]=o=>batchSettings.connectionTimeout=o),min:1e3,max:3e4,step:1e3,size:"small",style:{width:"140px"}},null,8,["value"])]),createBaseVNode("div",_hoisted_150,[e[216]||(e[216]=createBaseVNode("label",{class:"setting-label"},"重连等待时间(ms)",-1)),createVNode(h,{value:batchSettings.reconnectDelay,"onUpdate:value":e[79]||(e[79]=o=>batchSettings.reconnectDelay=o),min:100,max:5e3,step:100,size:"small",style:{width:"140px"}},null,8,["value"])])]),createBaseVNode("div",_hoisted_151,[createVNode(t,{onClick:e[80]||(e[80]=o=>showBatchSettingsModal.value=!1),style:{"margin-right":"12px"}},{default:withCtx(()=>[...e[217]||(e[217]=[createTextVNode("取消",-1)])]),_:1}),createVNode(t,{type:"primary",onClick:saveBatchSettings},{default:withCtx(()=>[...e[218]||(e[218]=[createTextVNode("保存设置",-1)])]),_:1})])])]),_:1},8,["show"])])}}},BatchDailyTasks=_export_sfc(_sfc_main,[["__scopeId","data-v-cd300bf0"]]);export{BatchDailyTasks as default};
