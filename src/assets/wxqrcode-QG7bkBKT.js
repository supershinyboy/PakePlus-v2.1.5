import{k as U,c as v,a as i,i as y,x as de,q as pe,s as fe,z as he,r as f,o as me,O as we,j as T,b as u,w as h,u as m,N as j,B as ge,t as F,d as W,H as ve}from"./index-BpMbMj_Q.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{R as xe}from"./Refresh-CoAARex0.js";const ke={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},be=i("path",{d:"M289.94 256l95-95A24 24 0 0 0 351 127l-95 95l-95-95a24 24 0 0 0-34 34l95 95l-95 95a24 24 0 1 0 34 34l95-95l95 95a24 24 0 0 0 34-34z",fill:"currentColor"},null,-1),Se=[be],Ee=U({name:"Close",render:function(b,g){return y(),v("svg",ke,Se)}}),Ce={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Re=i("path",{d:"M258.9 48C141.92 46.42 46.42 141.92 48 258.9c1.56 112.19 92.91 203.54 205.1 205.1c117 1.6 212.48-93.9 210.88-210.88C462.44 140.91 371.09 49.56 258.9 48zm126.42 327.25a4 4 0 0 1-6.14-.32a124.27 124.27 0 0 0-32.35-29.59C321.37 329 289.11 320 256 320s-65.37 9-90.83 25.34a124.24 124.24 0 0 0-32.35 29.58a4 4 0 0 1-6.14.32A175.32 175.32 0 0 1 80 259c-1.63-97.31 78.22-178.76 175.57-179S432 158.81 432 256a175.32 175.32 0 0 1-46.68 119.25z",fill:"currentColor"},null,-1),Ie=i("path",{d:"M256 144c-19.72 0-37.55 7.39-50.22 20.82s-19 32-17.57 51.93C191.11 256 221.52 288 256 288s64.83-32 67.79-71.24c1.48-19.74-4.8-38.14-17.68-51.82C293.39 151.44 275.59 144 256 144z",fill:"currentColor"},null,-1),Te=[Re,Ie],je=U({name:"PersonCircleOutline",render:function(b,g){return y(),v("svg",Ce,Te)}}),qe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ze=i("path",{d:"M342 444h46a56 56 0 0 0 56-56v-46",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"44"},null,-1),Ne=i("path",{d:"M444 170v-46a56 56 0 0 0-56-56h-46",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"44"},null,-1),Pe=i("path",{d:"M170 444h-46a56 56 0 0 1-56-56v-46",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"44"},null,-1),Ue=i("path",{d:"M68 170v-46a56 56 0 0 1 56-56h46",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"44"},null,-1),Ve=[ze,Ne,Pe,Ue],He=U({name:"Scan",render:function(b,g){return y(),v("svg",qe,Ve)}}),Ae={class:"wx-qrcode-import"},Me={class:"qrcode-container"},Ge=["src"],Oe={class:"account-name-input"},De={class:"form-actions"},Q=12e4,Xe={__name:"wxqrcode",emits:["cancel","ok"],setup(q,{emit:b}){const g=de(),{storeArrayBuffer:Z}=pe();fe();const K=he({name:"",server:"",wsUrl:""}),$=b,x=f(null),S=f(null),w=f(!1),V=f("点击获取微信登录二维码"),H=f("info"),z=f(null),N=f(!1),E=f(null),A=f(null),M=async()=>{try{if(w.value=!0,d("正在获取二维码...","info"),P(),!await ee())throw new Error("二维码获取失败")}catch(e){d("二维码获取失败："+e.message,"error"),console.error("获取二维码失败:",e)}finally{w.value=!1}},ee=async()=>{var e;try{const o="/api/weixin/connect/app/qrconnect?appid=wxfb0d5667e5cb1c44&bundleid=com.hortor.games.xyzw&scope=snsapi_base,snsapi_userinfo,snsapi_friend,snsapi_message&state=weixin",t=await new Promise((a,c)=>{const l=new XMLHttpRequest;l.open("GET",o,!0),l.timeout=15e3,l.setRequestHeader("Accept","text/html"),l.onload=()=>a(l),l.onerror=()=>c(new Error("网络错误")),l.ontimeout=()=>c(new Error("请求超时")),l.send()});if(t.status!==200)throw new Error("HTTP 状态码："+t.status);const r=t.responseText;let n=(e=new DOMParser().parseFromString(r,"text/html").querySelector("img.auth_qrcode"))==null?void 0:e.src;if(!n){const a=r.match(/https:\/\/[^"']*qrcode[^"']*/i);a&&(n=a[0])}if(!n)throw new Error("未找到二维码图片地址");return S.value=n.split("/").pop().split("?")[0],x.value=n,d("请使用微信扫码登录","success"),oe(),!0}catch(o){return console.error("二维码解析失败:",o),d("二维码获取失败："+o.message,"error"),!1}},oe=()=>{N.value||(N.value=!0,A.value=Date.now(),E.value=setInterval(()=>{ne()},1e3))},ne=async()=>{try{if(!S.value)return;const e=Date.now()-A.value;if(e>Q){d("二维码已超时，请重新获取","error"),k(),P();return}const o="/api/weixin/connect/l/qrconnect?uuid="+S.value+"&f=url&_="+Date.now(),t=await new Promise(s=>{const n=new XMLHttpRequest;n.open("GET",o,!0),n.timeout=5e3,n.setRequestHeader("Accept","*/*"),n.onload=()=>s(n),n.onerror=()=>s({status:0}),n.ontimeout=()=>s({status:0}),n.send()});if(t.status===200){const s=t.responseText;if(s.includes("window.wx_errcode=405")){const n=s.match(/wx_redirecturl='[^']*code=([a-zA-Z0-9]+)/),a=s.match(/window\.wx_nickname\s*=\s*['"]([^'"]+)['"]/);if(n){const c=n[1],l=a?a[1]:"";k(),d(`扫码成功，正在登录... 用户：${l||"未知用户"}`,"success"),await te(c,l);return}}if(s.includes("window.wx_errcode=408")){d("二维码已过期，请重新生成","error"),k(),P();return}}const r=Math.ceil((Q-e)/1e3);r%30===0&&d(`请扫码，剩余 ${r} 秒`,"info")}catch(e){console.error("扫码状态检查失败:",e)}},k=()=>{N.value=!1,E.value&&(clearInterval(E.value),E.value=null)},te=async(e,o="")=>{try{w.value=!0;const t=await re(e);t&&await ie(t,o)}catch(t){d("处理失败："+t.message,"error"),console.error("扫码处理失败:",t)}finally{w.value=!1}},re=async e=>{var I,B,L,_;const t=JSON.stringify({gameId:"xyzwapp",code:e,gameTp:"app",sysInfo:'{"system":"Android","hortorSDKVersion":"4.0.6-cn","model":"22081212C","brand":"Redmi"}',channel:"android",appFrom:"com.tencent.mm",noLogin:"2",distinctId:"DID-a38175b7-14ce-4b36-aa89-3e092ea03ea6",state:"hortor",packageName:"com.hortor.games.xyzw",tp:"app-we",signPrint:"E6:F7:FE:A9:EC:8E:24:D0:4F:2A:32:50:28:78:E1:C5:5E:70:81:13"});console.log("原始登录 JSON:",t);const r=G(t);try{console.log("加密后的登录 JSON:",r),console.log("解密:",se(r))}catch{}const s="/api/hortor/comb-login-server/api/v1/login?gameId=xyzwapp&timestamp="+Date.now()+"&version=android-4.2.1-cn-release&cryptVersion=1.1.0&gameTp=app&system=android&deviceUniqueId=DID-0e782e88-2f3b-4f5b-9020-47f5e5a5a026&packageName=com.hortorgames.xyzw",n=await new Promise((J,Y)=>{const p=new XMLHttpRequest;p.open("POST",s,!0),p.timeout=15e3,p.setRequestHeader("Accept","*/*"),p.setRequestHeader("Content-Type","text/plain; charset=utf-8"),p.onload=()=>J(p),p.onerror=()=>Y(new Error("登录失败")),p.ontimeout=()=>Y(new Error("登录超时")),p.send(r)});if(n.status!==200)throw new Error("HTTP 状态码："+n.status);const a=JSON.parse(n.responseText);if(((I=a.meta)==null?void 0:I.errCode)!==0)throw new Error("登录失败："+((B=a.meta)==null?void 0:B.errMsg));const c=(L=a.data)==null?void 0:L.combUser;if(!c)throw new Error("登录响应结构异常");console.log("combUser:",c);const l=(_=window.__require)==null?void 0:_.call(window,"13");if(!(l!=null&&l.encMsg)||!(l!=null&&l.lz4XorEncode))throw new Error("游戏加密模块未加载，不能生成 bin");const R=l.encMsg({platform:"hortor",platformExt:"mix",info:c,serverId:null,scene:0,referrerInfo:""},{decrypt:l.lz4XorDecode,encrypt:l.lz4XorEncode});return new Uint8Array(R)},G=e=>{const o="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";console.log("原始文本长度:",e.length);const n=ae(e,o,6,3,1);console.log("codeBase64:",(n==null?void 0:n.substring(0,100))+"...");const a=O(n);return console.log("编码结果长度:",a==null?void 0:a.length),a},se=e=>{const s=G.toString().match(/const cipherTable = "([^"]+)"/)[1],n=atob(e),a=C(s,6),c=D(a,3),l=X(n,c,1);return decodeURIComponent(escape(atob(l)))},ae=(e,o,t,r,s)=>{const n=O(e);{const a=C(o,t),c=D(a,r);return X(n,c,s)}},O=e=>e?btoa(unescape(encodeURIComponent(e))):null,C=(e,o)=>{if(o<=0)return e;if(e.length%2!==0)return null;const t=le(e),r=ce(e);return C(t,o-1)+C(r,o-1)},le=e=>e.length%2!==0?null:e.substring(Math.floor(e.length/2)),ce=e=>e.length%2!==0?null:e.substring(0,Math.floor(e.length/2)),D=(e,o)=>{const t=e.split(""),r=[],s=Math.floor(e.length/o);for(let n=0;n<s;n++)r.push(t[n*o]);return r.join("")},X=(e,o,t)=>{if(!e||!o)return null;const r=e.split(""),s=o.split(""),n=new Array(r.length);let a=s.length>>t;for(let c=0;c<r.length;c++)a>=s.length&&(a=0),n[c]=String.fromCharCode(r[c].charCodeAt(0)^s[a].charCodeAt(0)),a++;return n.join("")},ie=async(e,o="")=>{var R;let t=(R=z.value)==null?void 0:R.trim();console.log("name:",t);const r=new Uint8Array(e),s=await ve(r.buffer),n=JSON.parse(s);console.log("roleTokenJson.roleId:",n.roleId),t||(t=o||"微信账号_"+new Date().getTime(),t+="-"+n.roleId);const a=t,c={name:a,token:s,server:"",wsUrl:K.wsUrl||"",importMethod:"wxQrcode"};Z(a,r);const l=g.gameTokens.find(I=>I.name===a);l?(console.log("移除同名token:",l),g.updateToken(l.id,{...c})):g.addToken({...c}),ue(t+".bin",r),$("ok")},ue=(e,o)=>{const t=new Blob([new Uint8Array(o)],{type:"application/octet-stream"}),r=URL.createObjectURL(t),s=document.createElement("a");s.href=r,s.download=e,s.click(),URL.revokeObjectURL(r)},d=(e,o="info")=>{V.value=e,H.value=o},P=()=>{k(),S.value=null,x.value=null,d("点击获取微信登录二维码","info")};return me(()=>{}),we(()=>{k()}),(e,o)=>{const t=W("n-input"),r=W("n-button");return y(),v("div",Ae,[o[4]||(o[4]=i("div",{class:"login-flow-info"},[i("h3",null,"微信扫码登录流程"),i("ol",{class:"flow-steps"},[i("li",null,"点击下方按钮获取微信登录二维码"),i("li",null,"使用微信扫码并确认登录"),i("li",null,[T(" 系统将获取"),i("strong",{color:"red"},"最近一次登录"),T("的角色Token信息 ")])])],-1)),i("div",Me,[x.value?(y(),v("img",{key:1,id:"qr-image",src:x.value,alt:"微信登录二维码",class:"qr-image"},null,8,Ge)):(y(),v("div",{key:0,id:"qr-placeholder",class:"qr-placeholder",onClick:M},[u(m(j),{size:"48",color:"var(--text-tertiary)"},{default:h(()=>[u(m(He))]),_:1}),o[2]||(o[2]=i("p",null,"点击获取微信登录二维码",-1))])),i("div",{id:"qr-status",class:ge(["qr-status",H.value])},F(V.value),3)]),i("div",Oe,[u(t,{value:z.value,"onUpdate:value":o[0]||(o[0]=s=>z.value=s),placeholder:"请输入账号名称（例如：微信账号1）",disabled:w.value},{prefix:h(()=>[u(m(j),null,{default:h(()=>[u(m(je))]),_:1})]),_:1},8,["value","disabled"])]),i("div",De,[u(r,{type:"primary",block:"",onClick:M,loading:w.value},{icon:h(()=>[u(m(j),null,{default:h(()=>[u(m(xe))]),_:1})]),default:h(()=>[T(" "+F(x.value?"刷新二维码":"获取二维码"),1)]),_:1},8,["loading"]),u(r,{block:"",onClick:o[1]||(o[1]=s=>e.$emit("cancel")),disabled:w.value},{icon:h(()=>[u(m(j),null,{default:h(()=>[u(m(Ee))]),_:1})]),default:h(()=>[o[3]||(o[3]=T(" 取消 ",-1))]),_:1},8,["disabled"])])])}}},Je=ye(Xe,[["__scopeId","data-v-ba9bdf4e"]]);export{Je as default};
